"use strict";(self.webpackChunkshop_map_react=self.webpackChunkshop_map_react||[]).push([[8499],{51e3:function(e,t,r){r.d(t,{J:function(){return s},r:function(){return a}});var i=null,n=!0;function a(e,t,r){if(!e||!t)throw new Error("Cannot construct image data without dimensions");if(n)try{return new ImageData(e,t)}catch(o){n=!1}return u(e,t,r)}function s(e,t,r,i){if(!t||!r)throw new Error("Cannot construct image data without dimensions");if(n)try{return new ImageData(e,t,r)}catch(s){n=!1}var a=u(t,r,i);return a.data.set(e,0),a}function o(){return i||((i=document.createElement("canvas")).width=1,i.height=1),i}function u(e,t,r){return r||(r=o()),r.getContext("2d").createImageData(e,t)}},38330:function(e,t,r){r.d(t,{t:function(){return o}});var i=r(74165),n=r(1413),a=r(15861),s=r(76200);function o(e,t){return u.apply(this,arguments)}function u(){return u=(0,a.Z)((0,i.Z)().mark((function e(t,r){var a,o;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,s.default)(t,(0,n.Z)({responseType:"image"},r));case 2:return a=e.sent,o=a.data,e.abrupt("return",o);case 5:case"end":return e.stop()}}),e)}))),u.apply(this,arguments)}},17653:function(e,t,r){r.d(t,{Z:function(){return B}});var i=r(1413),n=r(74165),a=r(15861),s=r(15671),o=r(43144),u=r(76200),h=r(10064),l=r(66978),c=r(37762),d=r(52522),f=r(38499);function _(e,t){return p.apply(this,arguments)}function p(){return p=(0,a.Z)((0,n.Z)().mark((function e(t,r){var i,a,s,o,u,h,_,p,g,v,m,b,y,T;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!((i=(0,d.p)(t))instanceof Error)){e.next=3;break}throw i;case 3:return e.next=5,i.createImages();case 5:(0,l.k_)(r),a=i.frames,s=i.width,o=i.height,(u=document.createElement("canvas")).width=s,u.height=o,h=u.getContext("2d",{willReadFrequently:!0}),_=[],p=[],g=(0,c.Z)(a);try{for(g.s();!(v=g.n()).done;)m=v.value,p.push((0,f.HA)(m.delay||100)),b=m.imageElement,0===m.blendOp?h.globalCompositeOperation="copy":h.globalCompositeOperation="source-over",y=2===m.disposeOp?h.getImageData(m.left,m.top,m.width,m.height):void 0,h.drawImage(b,m.left,m.top),T=h.getImageData(0,0,s,o),_.push(T),0===m.disposeOp||(1===m.disposeOp?h.clearRect(m.left,m.top,m.width,m.height):2===m.disposeOp&&h.putImageData(y,m.left,m.top))}catch(n){g.e(n)}finally{g.f()}return e.abrupt("return",{frameDurations:p,getFrame:function(e){return _[e]},width:s,height:o});case 12:case"end":return e.stop()}}),e)}))),p.apply(this,arguments)}var g=[137,80,78,71,13,10,26,10];function v(e){var t=new Uint8Array(e);return!g.some((function(e,r){return e!==t[r]}))}function m(e){if(!v(e))return!1;var t,r=new DataView(e),i=new Uint8Array(e),n=8;do{var a=r.getUint32(n);if("acTL"===(t=String.fromCharCode.apply(String,Array.prototype.slice.call(i.subarray(n+4,n+8)))))return!0;n+=12+a}while("IEND"!==t&&n<i.length);return!1}var b=r(91958),y=r(47191);function T(e,t){return w.apply(this,arguments)}function w(){return w=(0,a.Z)((0,n.Z)().mark((function e(t,r){var i,a,s,o,u,h,l,d,_,p,g,v,m,T,w,E;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=(0,y.p)(t),a=(0,y.d)(i,!0),s=i.lsd,o=s.width,u=s.height,(h=document.createElement("canvas")).width=o,h.height=u,l=h.getContext("2d",{willReadFrequently:!0}),d=[],_=[],p=(0,c.Z)(a);try{for(p.s();!(g=p.n()).done;)v=g.value,_.push((0,f.HA)(v.delay||100)),m=new ImageData(v.patch,v.dims.width,v.dims.height),T=(0,b.E0)(m),w=3===v.disposalType?l.getImageData(v.dims.left,v.dims.top,v.dims.width,v.dims.height):void 0,l.drawImage(T,v.dims.left,v.dims.top),E=l.getImageData(0,0,o,u),d.push(E),1===v.disposalType||(2===v.disposalType?l.clearRect(v.dims.left,v.dims.top,v.dims.width,v.dims.height):3===v.disposalType&&l.putImageData(w,v.dims.left,v.dims.top))}catch(r){p.e(r)}finally{p.f()}return e.abrupt("return",{frameDurations:_,getFrame:function(e){return d[e]},width:o,height:u});case 6:case"end":return e.stop()}}),e)}))),w.apply(this,arguments)}var E=[71,73,70];function x(e){if(!function(e){var t=new Uint8Array(e);return!E.some((function(e,r){return e!==t[r]}))}(e))return!1;for(var t=new DataView(e),r=t.getUint8(10),i=13+(128&r?3*Math.pow(2,1+(7&r)):0),n=0,a=!1;!a;){switch(t.getUint8(i++)){case 33:if(!s())return!1;break;case 44:o();break;case 59:a=!0;break;default:return!1}if(n>1)return!0}function s(){switch(t.getUint8(i++)){case 249:i++,i+=4,u();break;case 1:n++,i++,i+=12,u();break;case 254:u();break;case 255:i++,i+=8,i+=3,u();break;default:return!1}return!0}function o(){n++,i+=8;var e=t.getUint8(i++);i+=128&e?3*Math.pow(2,1+(7&e)):0,i++,u()}function u(){for(var e;e=t.getUint8(i++);)i+=e}return!1}var B=function(){function e(){(0,s.Z)(this,e),this._resourceMap=new Map,this._inFlightResourceMap=new Map,this.geometryEngine=null,this.geometryEnginePromise=null}return(0,o.Z)(e,[{key:"destroy",value:function(){this._inFlightResourceMap.clear(),this._resourceMap.clear()}},{key:"getResource",value:function(e){var t;return null!==(t=this._resourceMap.get(e))&&void 0!==t?t:null}},{key:"fetchResource",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t,r){var i,a,s=this;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(i=this._resourceMap.get(t))){e.next=3;break}return e.abrupt("return",{width:i.width,height:i.height});case 3:return a=this._inFlightResourceMap.get(t),e.abrupt("return",a?a.then((function(e){return{width:e.width,height:e.height}})):(a=F(t,r),this._inFlightResourceMap.set(t,a),a.then((function(e){return s._inFlightResourceMap.delete(t),s._resourceMap.set(t,e),{width:e.width,height:e.height}}),(function(){return{width:0,height:0}}))));case 5:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"deleteResource",value:function(e){this._inFlightResourceMap.delete(e),this._resourceMap.delete(e)}}]),e}();function R(e,t){return O.apply(this,arguments)}function O(){return O=(0,a.Z)((0,n.Z)().mark((function e(t,r){var a,s,o;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=window.URL.createObjectURL(t),e.prev=1,e.next=4,(0,u.default)(a,(0,i.Z)((0,i.Z)({},r),{},{responseType:"image"}));case 4:return s=e.sent,o=s.data,e.abrupt("return",o);case 9:if(e.prev=9,e.t0=e.catch(1),(0,l.D_)(e.t0)){e.next=13;break}throw new h.Z("mapview-invalid-resource","Could not fetch requested resource at ".concat(a));case 13:throw e.t0;case 14:return e.prev=14,window.URL.revokeObjectURL(a),e.finish(14);case 17:case"end":return e.stop()}}),e,null,[[1,9,14,17]])}))),O.apply(this,arguments)}function F(e,t){return k.apply(this,arguments)}function k(){return k=(0,a.Z)((0,n.Z)().mark((function e(t,r){var i,a,s,o;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,M(t,r);case 2:if(i=e.sent,a=i.arrayBuffer,s=i.mediaType,o="image/png"===s,"image/gif"!==s||!x(a)){e.next=8;break}return e.abrupt("return",T(a));case 8:if(!o||!m(a)){e.next=10;break}return e.abrupt("return",_(a,r));case 10:return e.abrupt("return",R(new Blob([a],{type:s}),r));case 11:case"end":return e.stop()}}),e)}))),k.apply(this,arguments)}function M(e,t){return U.apply(this,arguments)}function U(){return U=(0,a.Z)((0,n.Z)().mark((function e(t,r){var a,s,o,c,d,f,_,p,g,v;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=";base64,",!t.includes(s)){e.next=7;break}for(o=t.indexOf(s),c=t.indexOf(s)+8,d=t.substring(c),f=atob(d),_=new Uint8Array(f.length),p=0;p<f.length;p++)_[p]=f.charCodeAt(p);a={arrayBuffer:_.buffer,mediaType:t.substring(0,o).replace("data:","")},e.next=19;break;case 7:return e.prev=7,e.next=10,(0,u.default)(t,(0,i.Z)({responseType:"array-buffer"},r));case 10:g=e.sent,v=g.data,a={arrayBuffer:v,mediaType:g.getHeader("Content-Type")},e.next=19;break;case 15:if(e.prev=15,e.t0=e.catch(7),(0,l.D_)(e.t0)){e.next=19;break}throw new h.Z("mapview-invalid-resource","Could not fetch requested resource at ".concat(t));case 19:return e.abrupt("return",a);case 20:case"end":return e.stop()}}),e,null,[[7,15]])}))),U.apply(this,arguments)}},8499:function(e,t,r){r.r(t),r.d(t,{GraphicContainer:function(){return ot.Z},GraphicsView2D:function(){return st.Z},LabelManager:function(){return at.Z},MagnifierView2D:function(){return yt},MapViewNavigation:function(){return ut.Z},Stage:function(){return nt}});var i=r(74165),n=r(1413),a=r(15861),s=r(37762),o=r(15671),u=r(43144),h=r(97326),l=r(11752),c=r(61120),d=r(60136),f=r(29388),_=r(10064),p=r(98928),g=r(93169),v=r(92026),m=r(99346),b=r(23588),y=r(17653),T=r(33624),w=r(39484),E=r(80613),x=r(62272),B=r(10106),R=r(34052),O=r(65706),F=function(e){return(0,O.K)({ID:e.id,PATTERN:e.pattern})},k={shaders:function(e){return{vertexShader:F(e)+(0,R.w)("background/background.vert"),fragmentShader:F(e)+(0,R.w)("background/background.frag")}}},M=function(e){return(0,O.K)({ID:e.id})},U={shaders:function(e){return{vertexShader:M(e)+(0,R.w)("circle/circle.vert"),fragmentShader:M(e)+(0,R.w)("circle/circle.frag")}}},P=function(e){return(0,O.K)({ID:e.id,PATTERN:e.pattern})},S={shaders:function(e){return{vertexShader:P(e)+(0,R.w)("fill/fill.vert"),fragmentShader:P(e)+(0,R.w)("fill/fill.frag")}}},A=function(e){return(0,O.K)({ID:e.id})},C={shaders:function(e){return{vertexShader:A(e)+(0,R.w)("outline/outline.vert"),fragmentShader:A(e)+(0,R.w)("outline/outline.frag")}}},N=function(e){return(0,O.K)({ID:e.id,SDF:e.sdf})},I={shaders:function(e){return{vertexShader:N(e)+(0,R.w)("icon/icon.vert"),fragmentShader:N(e)+(0,R.w)("icon/icon.frag")}}},Z=function(e){return(0,O.K)({ID:e.id,PATTERN:e.pattern,SDF:e.sdf})},D={shaders:function(e){return{vertexShader:Z(e)+(0,R.w)("line/line.vert"),fragmentShader:Z(e)+(0,R.w)("line/line.frag")}}},L=function(e){return(0,O.K)({ID:e.id})},z={shaders:function(e){return{vertexShader:L(e)+(0,R.w)("text/text.vert"),fragmentShader:L(e)+(0,R.w)("text/text.frag")}}},G=function(){function e(){(0,o.Z)(this,e),this._programByKey=new Map}return(0,u.Z)(e,[{key:"dispose",value:function(){this._programByKey.forEach((function(e){return e.dispose()})),this._programByKey.clear()}},{key:"getMaterialProgram",value:function(e,t,r){var i=t.key<<3|this._getMaterialOptionsValue(t.type,r);if(this._programByKey.has(i))return this._programByKey.get(i);var n=(0,this._getProgramTemplate(t.type).shaders)(r),a=n.vertexShader,s=n.fragmentShader,o=t.getShaderHeader(),u=t.getShaderMain(),h=a.replace("#pragma header",o).replace("#pragma main",u),l=e.programCache.acquire(h,s,t.getAttributeLocations());return this._programByKey.set(i,l),l}},{key:"_getMaterialOptionsValue",value:function(e,t){switch(e){case B._K.BACKGROUND:var r=t;return(r.pattern?1:0)<<1|(r.id?1:0);case B._K.FILL:var i=t;return(i.pattern?1:0)<<1|(i.id?1:0);case B._K.OUTLINE:return t.id?1:0;case B._K.LINE:var n=t;return(n.sdf?1:0)<<2|(n.pattern?1:0)<<1|(n.id?1:0);case B._K.ICON:var a=t;return(a.sdf?1:0)<<1|(a.id?1:0);case B._K.CIRCLE:case B._K.TEXT:return t.id?1:0;default:return 0}}},{key:"_getProgramTemplate",value:function(e){switch(e){case B._K.BACKGROUND:return k;case B._K.CIRCLE:return U;case B._K.FILL:return S;case B._K.ICON:return I;case B._K.LINE:return D;case B._K.OUTLINE:return C;case B._K.TEXT:return z;default:return null}}}]),e}(),V=r(61441),H=r(53456),q=r(44070),W=r(8548),j=r(96721),X=r(45412),K=function(){function e(){(0,o.Z)(this,e),this._initialized=!1}return(0,u.Z)(e,[{key:"dispose",value:function(){this._program=(0,v.M2)(this._program),this._vertexArrayObject=(0,v.M2)(this._vertexArrayObject)}},{key:"render",value:function(e,t,r,i){e&&(this._initialized||this._initialize(e),e.setBlendFunctionSeparate(W.zi.ONE,W.zi.ONE_MINUS_SRC_ALPHA,W.zi.ONE,W.zi.ONE_MINUS_SRC_ALPHA),e.bindVAO(this._vertexArrayObject),e.useProgram(this._program),t.setSamplingMode(r),e.bindTexture(t,0),this._program.setUniform1i("u_tex",0),this._program.setUniform1f("u_opacity",i),e.drawArrays(W.MX.TRIANGLE_STRIP,0,4),e.bindTexture(null,0),e.bindVAO())}},{key:"_initialize",value:function(e){if(this._initialized)return!0;var t=(0,j.H)(e,H.Q);if(!t)return!1;var r=new Int8Array(16);r[0]=-1,r[1]=-1,r[2]=0,r[3]=0,r[4]=1,r[5]=-1,r[6]=1,r[7]=0,r[8]=-1,r[9]=1,r[10]=0,r[11]=1,r[12]=1,r[13]=1,r[14]=1,r[15]=1;var i=H.Q.attributes,n=new X.U(e,i,V.As,{geometry:q.f.createVertex(e,W.l1.STATIC_DRAW,r)});return this._program=t,this._vertexArrayObject=n,this._initialized=!0,!0}}]),e}(),Y=r(4942),Q=r(40658),J=function(e){return e===E.jx.HITTEST||e===E.jx.LABEL_ALPHA},$=function(e,t,r){var i=e.rendererInfo,n=e.drawPhase;return"".concat(t.getVariationHash(),"-").concat(function(e){return(J(e)?1:0)|(e===E.jx.HIGHLIGHT?2:0)}(n),"-").concat(i.getVariationHash(),"-").concat((0,v.pC)(r)&&r.join("."))},ee=function(){function e(t){(0,o.Z)(this,e),this._rctx=t,this._programByKey=new Map}return(0,u.Z)(e,[{key:"dispose",value:function(){this._programByKey.forEach((function(e){return e.dispose()})),this._programByKey.clear()}},{key:"getProgram",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=e.vsPath+"."+e.fsPath+JSON.stringify(t);if(this._programByKey.has(r))return this._programByKey.get(r);var i=(0,n.Z)({},t.map((function(e){return"string"==typeof e?{name:e,value:!0}:e})).reduce((function(e,t){return(0,n.Z)((0,n.Z)({},e),{},(0,Y.Z)({},t.name,t.value))}),{})),a=e.vsPath,s=e.fsPath,o=e.attributes,u=(0,Q.s)(a,s,o,i),h=this._rctx.programCache.acquire(u.shaders.vertexShader,u.shaders.fragmentShader,u.attributes);if(!h)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(r,h),h}},{key:"getMaterialProgram",value:function(e,t,r,i,a){var o=$(e,t,a);if(this._programByKey.has(o))return this._programByKey.get(o);var u=function(e,t,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(i=(0,n.Z)((0,n.Z)((0,n.Z)((0,n.Z)({},i),t.getVariation()),e.rendererInfo.getVariation()),{},{highlight:e.drawPhase===E.jx.HIGHLIGHT,id:J(e.drawPhase)}),(0,v.pC)(r)){var a,o=(0,s.Z)(r);try{for(o.s();!(a=o.n()).done;)i[a.value]=!0}catch(u){o.e(u)}finally{o.f()}}return i}(e,t,a,{ignoresSamplerPrecision:e.context.driverTest.ignoresSamplerPrecision.result}),h=(0,Q.s)(r,r,i,u),l=this._rctx.programCache.acquire(h.shaders.vertexShader,h.shaders.fragmentShader,h.attributes);if(!l)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(o,l),l}}]),e}(),te=r(62013),re=r(66978),ie=r(94109),ne=r(49800),ae=function(){function e(t,r){(0,o.Z)(this,e),this._queue=[],this._context=t,this._refreshable=r}return(0,u.Z)(e,[{key:"destroy",value:function(){this._queue=[]}},{key:"enqueueTextureUpdate",value:function(e,t){var r=(0,re.hh)(),i=e,n=ie.u4,a=Math.ceil(i.height/n);if((0,re.k_)(t),this._context.type===ne.zO.WEBGL1)this._queue.push({type:"no-chunk",request:e,resolver:r,options:t});else for(var s=0;s<a;s++){var o=s*n,u=s===a-1,h=u?i.height-n*s:n;this._queue.push({type:"chunk",request:e,resolver:r,chunk:s,chunkOffset:o,destHeight:h,chunkIsLast:u,options:t})}return(0,re.$F)(t,(function(e){return r.reject(e)})),r.promise}},{key:"upload",value:function(){for(var e=0;this._queue.length;){var t=performance.now(),r=this._queue.shift();if(r){if((0,v.pC)(r.options.signal)&&r.options.signal.aborted)continue;switch(r.type){case"chunk":this._uploadChunk(r);break;case"no-chunk":this._uploadNoChunk(r)}var i=performance.now()-t;if((e+=i)+i>=ie.nb)break}}this._queue.length&&this._refreshable.requestRender()}},{key:"_uploadChunk",value:function(e){var t=e.request,r=e.resolver,i=e.chunkOffset,n=e.chunkIsLast,a=e.destHeight,s=t.data,o=t.texture,u=t.width;(0,v.pC)(s)&&(o.updateData(0,0,i,u,a,s,i),n&&r.resolve())}},{key:"_uploadNoChunk",value:function(e){var t=e.request,r=e.resolver,i=t.data;t.texture.setData(i),r.resolve()}}]),e}(),se=r(26277),oe=r(22753),ue=r(6394),he=r(11186),le=r(71353),ce=r(25866),de=r(92841),fe=(0,ue.f)(-.5,-.5),_e=function(){function e(){(0,o.Z)(this,e),this._centerNdc=(0,le.c)(),this._pxToNdc=(0,le.c)(),this._worldDimensionsPx=(0,le.c)(),this._mat3=(0,b.c)(),this._initialized=!1}return(0,u.Z)(e,[{key:"dispose",value:function(){this._program=(0,v.M2)(this._program),this._quad=(0,v.M2)(this._quad)}},{key:"render",value:function(e,t){var r=e.context;return!!this._updateGeometry(e,t)&&(this._initialized||this._initialize(r),r.setDepthWriteEnabled(!1),r.setDepthTestEnabled(!1),r.setColorMask(!1,!1,!1,!1),r.setBlendingEnabled(!1),r.setStencilOp(W.xS.KEEP,W.xS.KEEP,W.xS.REPLACE),r.setStencilFunction(W.wb.ALWAYS,1,255),r.setStencilTestEnabled(!0),r.useProgram(this._program),this._program.setUniformMatrix3fv("u_worldExtent",this._mat3),this._quad.draw(),this._quad.unbind(),!0)}},{key:"_initialize",value:function(e){if(!this._initialized){var t=(0,j.H)(e,de.H);t&&(this._program=t,this._quad=new ce.Z(e,[0,0,1,0,0,1,1,1]),this._initialized=!0)}}},{key:"_updateGeometry",value:function(e,t){var r=e.state,i=e.pixelRatio,n=r.size,a=r.rotation,s=Math.round(n[0]*i),o=Math.round(n[1]*i);if(!r.spatialReference.isWrappable)return!1;var u=(0,se.t)(a),h=Math.abs(Math.cos(u)),l=Math.abs(Math.sin(u)),c=Math.round(s*h+o*l),d=Math.round(r.worldScreenWidth);if(c<=d)return!1;var f=s*l+o*h,_=d*i,p=(t.left-t.right)*i/s,g=(t.bottom-t.top)*i/o;(0,he.s)(this._worldDimensionsPx,_,f,1),(0,he.s)(this._pxToNdc,2/s,-2/o,1),(0,he.s)(this._centerNdc,p,g,1);var v=this._mat3;return(0,oe.j)(v,this._centerNdc),(0,oe.d)(v,v,this._pxToNdc),0!==a&&(0,oe.r)(v,v,u),(0,oe.d)(v,v,this._worldDimensionsPx),(0,oe.h)(v,v,fe),!0}}]),e}(),pe=r(93879),ge=function(e){(0,d.Z)(r,e);var t=(0,f.Z)(r);function r(){var e;return(0,o.Z)(this,r),(e=t.apply(this,arguments)).defines=[],e._desc={vsPath:"fx/integrate",fsPath:"fx/integrate",attributes:new Map([["a_position",0]])},e}return(0,u.Z)(r,[{key:"dispose",value:function(){this._quad&&this._quad.dispose()}},{key:"bind",value:function(){}},{key:"unbind",value:function(){}},{key:"draw",value:function(e,t){if(null!==t&&void 0!==t&&t.size){var r=e.context,i=e.renderingOptions;this._quad||(this._quad=new ce.Z(r,[0,0,1,0,0,1,1,1]));var n=r.getBoundFramebufferObject(),a=r.getViewport(),s=a.x,o=a.y,u=a.width,h=a.height;t.bindTextures(r);var l=t.getBlock(ie.xl);if(!(0,v.Wi)(l)){var c=l.getFBO(r),d=l.getFBO(r,1);r.setViewport(0,0,t.size,t.size),this._computeDelta(e,d,i.labelsAnimationTime),this._updateAnimationState(e,d,c),r.bindFramebuffer(n),r.setViewport(s,o,u,h)}}}},{key:"_computeDelta",value:function(e,t,r){var i=e.context,n=e.painter,a=e.displayLevel,s=n.materialManager.getProgram(this._desc,["delta"]);i.bindFramebuffer(t),i.setClearColor(0,0,0,0),i.clear(i.gl.COLOR_BUFFER_BIT),i.useProgram(s),s.setUniform1i("u_maskTexture",ie.iJ),s.setUniform1i("u_sourceTexture",ie.nM),s.setUniform1f("u_timeDelta",e.deltaTime),s.setUniform1f("u_animationTime",r),s.setUniform1f("u_zoomLevel",Math.round(10*a)),this._quad.draw()}},{key:"_updateAnimationState",value:function(e,t,r){var i=e.context,n=e.painter.materialManager.getProgram(this._desc,["update"]);i.bindTexture(t.colorTexture,1),i.useProgram(n),n.setUniform1i("u_sourceTexture",1),i.bindFramebuffer(r),i.setClearColor(0,0,0,0),i.clear(i.gl.COLOR_BUFFER_BIT),this._quad.draw()}}]),r}(pe.Q),ve=r(23174),me=function(e){(0,d.Z)(r,e);var t=(0,f.Z)(r);function r(e){var i;return(0,o.Z)(this,r),(i=t.call(this)).name=i.constructor.name,i.defines=[e],i}return(0,u.Z)(r,[{key:"dispose",value:function(){}},{key:"bind",value:function(e){var t=e.context,r=e.painter;this._prev=t.getBoundFramebufferObject();var i=t.getViewport(),n=i.width,a=i.height,s=r.getFbos(n,a).effect0;t.bindFramebuffer(s),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT)}},{key:"unbind",value:function(){}},{key:"draw",value:function(e,t){var r,i=e.context,n=e.painter,a=n.getPostProcessingEffects(t),o=i.getBoundFramebufferObject(),u=(0,s.Z)(a);try{for(u.s();!(r=u.n()).done;){var h=r.value,l=h.postProcessingEffect,c=h.effect;l.draw(e,o,c)}}catch(d){u.e(d)}finally{u.f()}i.bindFramebuffer(this._prev),i.setStencilTestEnabled(!1),n.blitTexture(i,o.colorTexture,W.cw.NEAREST),i.setStencilTestEnabled(!0)}}]),r}(pe.Q),be=r(17615),ye=r(93985),Te=r(61109),we=function(){function e(){(0,o.Z)(this,e),this._width=void 0,this._height=void 0,this._resources=null}return(0,u.Z)(e,[{key:"dispose",value:function(){this._resources&&(this._resources.quadGeometry.dispose(),this._resources.quadVAO.dispose(),this._resources.highlightProgram.dispose(),this._resources.blurProgram.dispose(),this._resources=null)}},{key:"preBlur",value:function(e,t){e.bindTexture(t,ie.QU),e.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[1,0,1/this._width,0]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",be.n5),e.bindVAO(this._resources.quadVAO),e.drawArrays(W.MX.TRIANGLE_STRIP,0,4),e.bindVAO()}},{key:"finalBlur",value:function(e,t){e.bindTexture(t,ie.QU),e.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[0,1,0,1/this._height]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",be.QU),e.bindVAO(this._resources.quadVAO),e.drawArrays(W.MX.TRIANGLE_STRIP,0,4),e.bindVAO()}},{key:"renderHighlight",value:function(e,t,r){e.bindTexture(t,ie.QU),e.useProgram(this._resources.highlightProgram),r.applyHighlightOptions(e,this._resources.highlightProgram),e.bindVAO(this._resources.quadVAO),e.setBlendingEnabled(!0),e.setBlendFunction(W.zi.ONE,W.zi.ONE_MINUS_SRC_ALPHA),e.drawArrays(W.MX.TRIANGLE_STRIP,0,4),e.bindVAO()}},{key:"_initialize",value:function(e,t,r){this._width=t,this._height=r;var i=q.f.createVertex(e,W.l1.STATIC_DRAW,new Int8Array([-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1]).buffer),n=new X.U(e,new Map([["a_position",0],["a_texcoord",1]]),{geometry:[new Te.G("a_position",2,W.g.BYTE,0,4),new Te.G("a_texcoord",2,W.g.UNSIGNED_BYTE,2,4)]},{geometry:i}),a=(0,j.H)(e,ye.C),s=(0,j.H)(e,ye.y);e.useProgram(a),a.setUniform1i("u_texture",ie.QU),a.setUniform1i("u_shade",ie.Jw),a.setUniform1f("u_sigma",be.tM),e.useProgram(s),s.setUniform1i("u_texture",ie.QU),s.setUniform1f("u_sigma",be.tM),this._resources={quadGeometry:i,quadVAO:n,highlightProgram:a,blurProgram:s}}},{key:"setup",value:function(e,t,r){this._resources?(this._width=t,this._height=r):this._initialize(e,t,r)}}]),e}(),Ee=r(29439),xe=r(53634),Be=r(51378);function Re(e,t,r){var i=new Be.x(e,{target:W.No.TEXTURE_2D,pixelFormat:W.VI.RGBA,dataType:W.Br.UNSIGNED_BYTE,wrapMode:W.e8.CLAMP_TO_EDGE,width:t,height:r,samplingMode:W.cw.LINEAR});return[i,new xe.X(e,{colorTarget:W.Lm.TEXTURE,depthStencilTarget:W.OU.STENCIL_RENDER_BUFFER},i)]}var Oe=function(){function e(){(0,o.Z)(this,e),this._width=void 0,this._height=void 0,this._resources=null}return(0,u.Z)(e,[{key:"dispose",value:function(){this._resources&&(this._resources.sharedBlur1Tex.dispose(),this._resources.sharedBlur1Fbo.dispose(),this._resources.sharedBlur2Tex.dispose(),this._resources.sharedBlur2Fbo.dispose(),this._resources=(0,v.wN)(this._resources))}},{key:"_initialize",value:function(e,t,r){this._width=t,this._height=r;var i=Re(e,t,r),n=(0,Ee.Z)(i,2),a=n[0],s=n[1],o=Re(e,t,r),u=(0,Ee.Z)(o,2),h=u[0],l=u[1];this._resources={sharedBlur1Tex:a,sharedBlur1Fbo:s,sharedBlur2Tex:h,sharedBlur2Fbo:l}}},{key:"setup",value:function(e,t,r){!this._resources||this._width===t&&this._height===r||this.dispose(),this._resources||this._initialize(e,t,r)}},{key:"sharedBlur1Tex",get:function(){return this._resources.sharedBlur1Tex}},{key:"sharedBlur1Fbo",get:function(){return this._resources.sharedBlur1Fbo}},{key:"sharedBlur2Tex",get:function(){return this._resources.sharedBlur2Tex}},{key:"sharedBlur2Fbo",get:function(){return this._resources.sharedBlur2Fbo}}]),e}(),Fe=function(e){(0,d.Z)(r,e);var t=(0,f.Z)(r);function r(){var e;return(0,o.Z)(this,r),(e=t.apply(this,arguments)).defines=["highlight"],e._hlRenderer=new we,e._width=void 0,e._height=void 0,e._boundFBO=null,e._hlSurfaces=new Oe,e._adjustedWidth=void 0,e._adjustedHeight=void 0,e._blitRenderer=new K,e}return(0,u.Z)(r,[{key:"dispose",value:function(){var e,t;null!==(e=this._hlSurfaces)&&void 0!==e&&e.dispose(),null!==(t=this._hlRenderer)&&void 0!==t&&t.dispose(),this._boundFBO=null}},{key:"bind",value:function(e){var t=e.context,r=e.painter,i=t.getViewport(),n=i.width,a=i.height,s=r.getFbos(n,a).effect0;this.setup(e,n,a),t.bindFramebuffer(s),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT)}},{key:"unbind",value:function(){}},{key:"setup",value:function(e,t,r){var i=e.context;this._width=t,this._height=r;var n=t%4,a=r%4;t+=n<2?-n:4-n,r+=a<2?-a:4-a,this._adjustedWidth=t,this._adjustedHeight=r,this._boundFBO=i.getBoundFramebufferObject();var s=Math.round(1*t),o=Math.round(1*r);this._hlRenderer.setup(i,s,o),this._hlSurfaces.setup(i,s,o)}},{key:"draw",value:function(e){var t=e.context,r=e.highlightGradient;if(r){var i=t.getBoundFramebufferObject();t.setViewport(0,0,1*this._adjustedWidth,1*this._adjustedHeight),t.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),t.setStencilTestEnabled(!1),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT),this._blitRenderer.render(t,i.colorTexture,W.cw.NEAREST,1),t.setStencilTestEnabled(!1),t.setBlendingEnabled(!1),t.setColorMask(!1,!1,!1,!0),t.bindFramebuffer(this._hlSurfaces.sharedBlur2Fbo),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT),this._hlRenderer.preBlur(t,this._hlSurfaces.sharedBlur1Tex),t.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT),this._hlRenderer.finalBlur(t,this._hlSurfaces.sharedBlur2Tex),t.bindFramebuffer(this._boundFBO),t.setBlendingEnabled(!0),t.setColorMask(!0,!0,!0,!0),t.setViewport(0,0,this._width,this._height),this._hlRenderer.renderHighlight(t,this._hlSurfaces.sharedBlur1Tex,r),this._boundFBO=null}}}]),r}(pe.Q),ke=function(e){(0,d.Z)(r,e);var t=(0,f.Z)(r);function r(){var e;return(0,o.Z)(this,r),(e=t.apply(this,arguments)).name=e.constructor.name,e.defines=["hittest"],e}return(0,u.Z)(r,[{key:"dispose",value:function(){(0,v.pC)(this._fbo)&&this._fbo.dispose()}},{key:"createOptions",value:function(e,t){var r=e.pixelRatio,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ie.dn;if(!t.length)return null;var n=t.shift(),a=n.x,s=n.y;return this._outstanding=n,{type:"hittest",distance:i*r,position:[a,s]}}},{key:"bind",value:function(e){var t=e.context,r=e.attributeView;if(r.size){var i=r.getBlock(ie.pU);if(!(0,v.Wi)(i)){var n=i.getFBO(t);t.setViewport(0,0,r.size,r.size),t.bindFramebuffer(n),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT|t.gl.DEPTH_BUFFER_BIT)}}}},{key:"unbind",value:function(e){}},{key:"draw",value:function(e){if(!(0,v.Wi)(this._outstanding)){var t=this._outstanding;this._outstanding=null,this._resolve(e,t.resolvers)}}},{key:"_resolve",value:function(){var e=(0,a.Z)((0,i.Z)().mark((function e(t,r){var n,a,s,o,u,h,l,c,d,f;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.context,a=t.attributeView,s=a.getBlock(ie.pU),!(0,v.Wi)(s)){e.next=3;break}return e.abrupt("return",void r.forEach((function(e){return e.resolve([])})));case 3:return o=s.getFBO(n),u=new Uint8Array(o.width*o.height*4),e.prev=4,e.next=7,o.readPixelsAsync(0,0,o.width,o.height,W.VI.RGBA,W.Br.UNSIGNED_BYTE,u);case 7:e.next=12;break;case 9:return e.prev=9,e.t0=e.catch(4),e.abrupt("return",void r.forEach((function(e){return e.resolve([])})));case 12:for(h=[],l=0;l<u.length;l+=4)c=u[l],d=u[l+3],c&&h.push({id:l/4,directHits:d});h.sort((function(e,t){return t.directHits===e.directHits?t.id-e.id:t.directHits-e.directHits})),f=h.map((function(e){return e.id})),r.forEach((function(e){return e.resolve(f)}));case 17:case"end":return e.stop()}}),e,null,[[4,9]])})));return function(t,r){return e.apply(this,arguments)}}()}]),r}(pe.Q),Me=function(e){(0,d.Z)(r,e);var t=(0,f.Z)(r);function r(){var e;return(0,o.Z)(this,r),(e=t.apply(this,arguments)).name=e.constructor.name,e.defines=["id"],e._lastSize=0,e._boundFBO=null,e}return(0,u.Z)(r,[{key:"dispose",value:function(){(0,v.pC)(this._fbo)&&this._fbo.dispose()}},{key:"bind",value:function(e){var t=e.context,r=e.painter,i=t.getViewport(),n=i.width,a=i.height;this._boundFBO=t.getBoundFramebufferObject();var s=r.getFbos(n,a).effect0;t.bindFramebuffer(s),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT)}},{key:"unbind",value:function(e){e.context.bindFramebuffer(this._boundFBO),this._boundFBO=null}},{key:"draw",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2*ie.dn;this._resolve(e,t,r)}},{key:"_resolve",value:function(){var e=(0,a.Z)((0,i.Z)().mark((function e(t,r,n){var s,o,u,h,l,c,d,f,_=this;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:s=t.context,o=t.state,u=t.pixelRatio,h=s.getBoundFramebufferObject(),l=o.size[1]*u,c=Math.round(n*u),d=c/2,f=c/2,this._ensureBuffer(c),r.forEach(function(){var e=(0,a.Z)((0,i.Z)().mark((function e(t,n){var a,s,o,p,g,v,m,b,y,T;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=new Map,s=Math.floor(n.x*u-c/2),o=Math.floor(l-n.y*u-c/2),e.next=3,h.readPixelsAsync(s,o,c,c,W.VI.RGBA,W.Br.UNSIGNED_BYTE,_._buf);case 3:for(p=0;p<_._buf32.length;p++)4294967295!==(g=_._buf32[p])&&0!==g&&(v=p%c,m=c-Math.floor(p/c),b=(d-v)*(d-v)+(f-m)*(f-m),y=a.has(g)?a.get(g):4294967295,a.set(g,Math.min(b,y)));T=Array.from(a).sort((function(e,t){return e[1]-t[1]})).map((function(e){return e[0]})),t.resolve(T),r.delete(n);case 6:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}());case 3:case"end":return e.stop()}}),e,this)})));return function(t,r,i){return e.apply(this,arguments)}}()},{key:"_ensureBuffer",value:function(e){this._lastSize!==e&&(this._lastSize=e,this._buf=new Uint8Array(4*e*e),this._buf32=new Uint32Array(this._buf.buffer))}}]),r}(pe.Q),Ue=[1,0],Pe=[0,1],Se=[1,.8,.6,.4,.2],Ae=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],Ce=function(){function e(){(0,o.Z)(this,e),this._intensityFBO=null,this._compositeFBO=null,this._mipsFBOs=new Array(5),this._nMips=5,this._kernelSizeArray=[3,5,7,9,11],this._size=[0,0],this._programDesc={luminosityHighPass:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/luminosityHighPass",attributes:new Map([["a_position",0]])},gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}return(0,u.Z)(e,[{key:"dispose",value:function(){if(this._quad=(0,v.M2)(this._quad),this._intensityFBO=(0,v.M2)(this._intensityFBO),this._compositeFBO=(0,v.M2)(this._compositeFBO),this._mipsFBOs){for(var e=0;e<this._nMips;e++)this._mipsFBOs[e]&&(this._mipsFBOs[e].horizontal.dispose(),this._mipsFBOs[e].vertical.dispose());this._mipsFBOs=null}}},{key:"draw",value:function(e,t,r){var i=t.width,n=t.height,a=e.context,s=e.painter.materialManager,o=a.gl,u=this._programDesc,h=r.strength,l=r.radius,c=r.threshold;this._quad||(this._quad=new ce.Z(a,[-1,-1,1,-1,-1,1,1,1])),this._createOrResizeResources(e,i,n),a.setStencilTestEnabled(!1),a.setBlendingEnabled(!0),a.setBlendFunction(W.zi.ONE,W.zi.ONE_MINUS_SRC_ALPHA),a.setStencilWriteMask(0);var d=this._quad;d.bind(),a.bindFramebuffer(this._intensityFBO);var f=s.getProgram(u.luminosityHighPass);a.useProgram(f),a.bindTexture(t.colorTexture,0),f.setUniform1i("u_texture",0),f.setUniform3fv("u_defaultColor",[0,0,0]),f.setUniform1f("u_defaultOpacity",0),f.setUniform1f("u_luminosityThreshold",c),f.setUniform1f("u_smoothWidth",.01);var _=[Math.round(i/2),Math.round(n/2)];a.setViewport(0,0,_[0],_[1]),a.setClearColor(0,0,0,0),a.clear(o.COLOR_BUFFER_BIT),d.draw(),a.setBlendingEnabled(!1);for(var p=this._intensityFBO.colorTexture,g=0;g<this._nMips;g++){var v=s.getProgram(u.gaussianBlur,[{name:"radius",value:this._kernelSizeArray[g]}]);a.useProgram(v),a.bindTexture(p,g+1),v.setUniform1i("u_colorTexture",g+1),v.setUniform2fv("u_texSize",_),v.setUniform2fv("u_direction",Ue),a.setViewport(0,0,_[0],_[1]);var m=this._mipsFBOs[g];a.bindFramebuffer(m.horizontal),d.draw(),p=m.horizontal.colorTexture,a.bindFramebuffer(m.vertical),a.bindTexture(p,g+1),v.setUniform2fv("u_direction",Pe),d.draw(),p=m.vertical.colorTexture,_[0]=Math.round(_[0]/2),_[1]=Math.round(_[1]/2)}a.setViewport(0,0,i,n);var b=s.getProgram(u.composite,[{name:"nummips",value:5}]);a.bindFramebuffer(this._compositeFBO),a.useProgram(b),b.setUniform1f("u_bloomStrength",h),b.setUniform1f("u_bloomRadius",l),b.setUniform1fv("u_bloomFactors",Se),b.setUniform3fv("u_bloomTintColors",Ae),a.bindTexture(this._mipsFBOs[0].vertical.colorTexture,1),b.setUniform1i("u_blurTexture1",1),a.bindTexture(this._mipsFBOs[1].vertical.colorTexture,2),b.setUniform1i("u_blurTexture2",2),a.bindTexture(this._mipsFBOs[2].vertical.colorTexture,3),b.setUniform1i("u_blurTexture3",3),a.bindTexture(this._mipsFBOs[3].vertical.colorTexture,4),b.setUniform1i("u_blurTexture4",4),a.bindTexture(this._mipsFBOs[4].vertical.colorTexture,5),b.setUniform1i("u_blurTexture5",5),d.draw(),a.bindFramebuffer(t),a.setBlendingEnabled(!0);var y=s.getProgram(u.blit);a.useProgram(y),a.bindTexture(this._compositeFBO.colorTexture,6),y.setUniform1i("u_texture",6),a.setBlendFunction(W.zi.ONE,W.zi.ONE),d.draw(),d.unbind(),a.setBlendFunction(W.zi.ONE,W.zi.ONE_MINUS_SRC_ALPHA),a.setStencilTestEnabled(!0)}},{key:"_createOrResizeResources",value:function(e,t,r){var i=e.context;if(!this._compositeFBO||this._size[0]!==t||this._size[1]!==r){this._size[0]=t,this._size[1]=r;var n=[Math.round(t/2),Math.round(r/2)];this._compositeFBO?this._compositeFBO.resize(t,r):this._compositeFBO=new xe.X(i,{colorTarget:W.Lm.TEXTURE,depthStencilTarget:W.OU.NONE,width:t,height:r}),this._intensityFBO?this._intensityFBO.resize(n[0],n[1]):this._intensityFBO=new xe.X(i,{colorTarget:W.Lm.TEXTURE,depthStencilTarget:W.OU.NONE,width:n[0],height:n[1]},{target:W.No.TEXTURE_2D,pixelFormat:W.VI.RGBA,internalFormat:W.VI.RGBA,dataType:W.Br.UNSIGNED_BYTE,wrapMode:W.e8.CLAMP_TO_EDGE,samplingMode:W.cw.LINEAR,flipped:!1,width:n[0],height:n[1]});for(var a=0;a<this._nMips;a++)this._mipsFBOs[a]?(this._mipsFBOs[a].horizontal.resize(n[0],n[1]),this._mipsFBOs[a].vertical.resize(n[0],n[1])):this._mipsFBOs[a]={horizontal:new xe.X(i,{colorTarget:W.Lm.TEXTURE,depthStencilTarget:W.OU.NONE,width:n[0],height:n[1]},{target:W.No.TEXTURE_2D,pixelFormat:W.VI.RGBA,internalFormat:W.VI.RGBA,dataType:W.Br.UNSIGNED_BYTE,wrapMode:W.e8.CLAMP_TO_EDGE,samplingMode:W.cw.LINEAR,flipped:!1,width:n[0],height:n[1]}),vertical:new xe.X(i,{colorTarget:W.Lm.TEXTURE,depthStencilTarget:W.OU.NONE,width:n[0],height:n[1]},{target:W.No.TEXTURE_2D,pixelFormat:W.VI.RGBA,internalFormat:W.VI.RGBA,dataType:W.Br.UNSIGNED_BYTE,wrapMode:W.e8.CLAMP_TO_EDGE,samplingMode:W.cw.LINEAR,flipped:!1,width:n[0],height:n[1]})},n[0]=Math.round(n[0]/2),n[1]=Math.round(n[1]/2)}}}]),e}(),Ne=[1,0],Ie=[0,1],Ze=function(){function e(){(0,o.Z)(this,e),this._blurFBO=null,this._size=[0,0],this._programDesc={gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},radialBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/radial-blur",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}return(0,u.Z)(e,[{key:"dispose",value:function(){this._blurFBO&&(this._blurFBO.dispose(),this._blurFBO=null)}},{key:"draw",value:function(e,t,r){var i=e.context,n=r.type,a=r.radius;if(0!==a){this._createOrResizeResources(e),this._quad||(this._quad=new ce.Z(i,[-1,-1,1,-1,-1,1,1,1]));var s=this._quad;s.bind(),"blur"===n?this._gaussianBlur(e,t,a):this._radialBlur(e,t),s.unbind()}}},{key:"_gaussianBlur",value:function(e,t,r){var i=e.context,n=e.state,a=e.painter,s=e.pixelRatio,o=n.size,u=a.materialManager,h=this._programDesc,l=this._quad,c=[Math.round(s*o[0]),Math.round(s*o[1])],d=this._blurFBO,f=u.getProgram(h.gaussianBlur,[{name:"radius",value:Math.ceil(r)}]);i.useProgram(f),i.setBlendingEnabled(!1),i.bindFramebuffer(d),i.bindTexture(t.colorTexture,4),f.setUniform1i("u_colorTexture",4),f.setUniform2fv("u_texSize",c),f.setUniform2fv("u_direction",Ne),f.setUniform1f("u_sigma",r),l.draw(),i.bindFramebuffer(t),i.setStencilWriteMask(0),i.setStencilTestEnabled(!1),i.setDepthWriteEnabled(!1),i.setDepthTestEnabled(!1),i.bindTexture(null===d||void 0===d?void 0:d.colorTexture,5),f.setUniform1i("u_colorTexture",5),f.setUniform2fv("u_direction",Ie),l.draw(),i.setBlendingEnabled(!0),i.setBlendFunction(W.zi.ONE,W.zi.ONE_MINUS_SRC_ALPHA),i.setStencilTestEnabled(!0)}},{key:"_radialBlur",value:function(e,t){var r=e.context,i=e.painter.materialManager,n=this._programDesc,a=this._quad,s=this._blurFBO;r.bindFramebuffer(s);var o=i.getProgram(n.radialBlur);r.useProgram(o),r.setBlendingEnabled(!1),r.bindTexture(t.colorTexture,4),o.setUniform1i("u_colorTexture",4),a.draw(),r.bindFramebuffer(t),r.setStencilWriteMask(0),r.setStencilTestEnabled(!1),r.setDepthWriteEnabled(!1),r.setDepthTestEnabled(!1),r.setBlendingEnabled(!0);var u=i.getProgram(n.blit);r.useProgram(u),r.bindTexture(null===s||void 0===s?void 0:s.colorTexture,5),u.setUniform1i("u_texture",5),r.setBlendFunction(W.zi.ONE,W.zi.ONE_MINUS_SRC_ALPHA),a.draw()}},{key:"_createOrResizeResources",value:function(e){var t=e.context,r=e.state,i=e.pixelRatio,n=r.size,a=Math.round(i*n[0]),s=Math.round(i*n[1]);this._blurFBO&&this._size[0]===a&&this._size[1]===s||(this._size[0]=a,this._size[1]=s,this._blurFBO?this._blurFBO.resize(a,s):this._blurFBO=new xe.X(t,{colorTarget:W.Lm.TEXTURE,depthStencilTarget:W.OU.NONE,width:a,height:s},{target:W.No.TEXTURE_2D,pixelFormat:W.VI.RGBA,internalFormat:W.VI.RGBA,dataType:W.Br.UNSIGNED_BYTE,wrapMode:W.e8.CLAMP_TO_EDGE,samplingMode:W.cw.LINEAR,flipped:!1,width:a,height:s}))}}]),e}(),De=function(){function e(){(0,o.Z)(this,e),this._layerFBOTexture=null,this._size=[0,0],this._programDesc={vsPath:"post-processing/pp",fsPath:"post-processing/filterEffect",attributes:new Map([["a_position",0]])}}return(0,u.Z)(e,[{key:"dispose",value:function(){this._layerFBOTexture=(0,v.M2)(this._layerFBOTexture)}},{key:"draw",value:function(e,t,r){var i=t.width,n=t.height;this._createOrResizeResources(e,i,n);var a=e.context,s=e.painter.materialManager,o=this._programDesc,u=this._quad,h=r.colorMatrix;u.bind();var l=this._layerFBOTexture;a.bindFramebuffer(t),t.copyToTexture(0,0,i,n,0,0,l),a.setBlendingEnabled(!1),a.setStencilTestEnabled(!1);var c=s.getProgram(o);a.useProgram(c),a.bindTexture(l,2),c.setUniformMatrix4fv("u_coefficients",h),c.setUniform1i("u_colorTexture",2),u.draw(),a.setBlendingEnabled(!0),a.setBlendFunction(W.zi.ONE,W.zi.ONE_MINUS_SRC_ALPHA),a.setStencilTestEnabled(!0),u.unbind()}},{key:"_createOrResizeResources",value:function(e,t,r){var i=e.context;this._layerFBOTexture&&this._size[0]===t&&this._size[1]===r||(this._size[0]=t,this._size[1]=r,this._layerFBOTexture?this._layerFBOTexture.resize(t,r):this._layerFBOTexture=new Be.x(i,{target:W.No.TEXTURE_2D,pixelFormat:W.VI.RGBA,internalFormat:W.VI.RGBA,dataType:W.Br.UNSIGNED_BYTE,wrapMode:W.e8.CLAMP_TO_EDGE,samplingMode:W.cw.LINEAR,flipped:!1,width:t,height:r}),this._quad||(this._quad=new ce.Z(i,[-1,-1,1,-1,-1,1,1,1])))}}]),e}(),Le=r(17842),ze=[1,0],Ge=[0,1],Ve=function(){function e(){(0,o.Z)(this,e),this._layerFBOTexture=null,this._horizontalBlurFBO=null,this._verticalBlurFBO=null,this._size=[0,0],this._quad=null,this._programDesc={blur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/drop-shadow/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}return(0,u.Z)(e,[{key:"dispose",value:function(){this._layerFBOTexture=(0,v.M2)(this._layerFBOTexture),this._horizontalBlurFBO=(0,v.M2)(this._horizontalBlurFBO),this._verticalBlurFBO=(0,v.M2)(this._verticalBlurFBO)}},{key:"draw",value:function(e,t,r){var i=e.context,n=e.state,a=e.painter.materialManager,s=this._programDesc,o=t.width,u=t.height,h=[Math.round(o),Math.round(u)],l=r.blurRadius,c=r.offsetX,d=r.offsetY,f=r.color,_=[(0,Le.F2)(c),(0,Le.F2)(d)];this._createOrResizeResources(e,o,u,h);var p=this._horizontalBlurFBO,g=this._verticalBlurFBO;i.setStencilWriteMask(0),i.setStencilTestEnabled(!1),i.setDepthWriteEnabled(!1),i.setDepthTestEnabled(!1);var v=this._layerFBOTexture;t.copyToTexture(0,0,o,u,0,0,v),this._quad||(this._quad=new ce.Z(i,[-1,-1,1,-1,-1,1,1,1])),i.setViewport(0,0,h[0],h[1]);var m=this._quad;m.bind(),i.setBlendingEnabled(!1);var b=a.getProgram(s.blur,[{name:"radius",value:Math.ceil(l)}]);i.useProgram(b),i.bindFramebuffer(p),i.bindTexture(t.colorTexture,4),b.setUniform1i("u_colorTexture",4),b.setUniform2fv("u_texSize",h),b.setUniform2fv("u_direction",ze),b.setUniform1f("u_sigma",l),m.draw(),i.bindFramebuffer(g),i.bindTexture(null===p||void 0===p?void 0:p.colorTexture,5),b.setUniform1i("u_colorTexture",5),b.setUniform2fv("u_direction",Ge),m.draw(),i.bindFramebuffer(t),i.setViewport(0,0,o,u);var y=a.getProgram(s.composite);i.useProgram(y),i.bindTexture(null===g||void 0===g?void 0:g.colorTexture,2),y.setUniform1i("u_blurTexture",2),i.bindTexture(v,3),y.setUniform1i("u_layerFBOTexture",3),y.setUniform4fv("u_shadowColor",[f[3]*(f[0]/255),f[3]*(f[1]/255),f[3]*(f[2]/255),f[3]]),y.setUniformMatrix3fv("u_displayViewMat3",n.displayMat3),y.setUniform2fv("u_shadowOffset",_),m.draw(),i.setBlendingEnabled(!0),i.setStencilTestEnabled(!0),i.setBlendFunction(W.zi.ONE,W.zi.ONE_MINUS_SRC_ALPHA),m.unbind()}},{key:"_createOrResizeResources",value:function(e,t,r,i){var n=e.context;this._horizontalBlurFBO&&this._size[0]===t&&this._size[1]===r||(this._size[0]=t,this._size[1]=r,this._horizontalBlurFBO?this._horizontalBlurFBO.resize(i[0],i[1]):this._horizontalBlurFBO=new xe.X(n,{colorTarget:W.Lm.TEXTURE,depthStencilTarget:W.OU.NONE,width:i[0],height:i[1]},{target:W.No.TEXTURE_2D,pixelFormat:W.VI.RGBA,internalFormat:W.VI.RGBA,dataType:W.Br.UNSIGNED_BYTE,wrapMode:W.e8.CLAMP_TO_EDGE,samplingMode:W.cw.LINEAR,flipped:!1,width:i[0],height:i[1]}),this._verticalBlurFBO?this._verticalBlurFBO.resize(i[0],i[1]):this._verticalBlurFBO=new xe.X(n,{colorTarget:W.Lm.TEXTURE,depthStencilTarget:W.OU.NONE,width:i[0],height:i[1]},{target:W.No.TEXTURE_2D,pixelFormat:W.VI.RGBA,internalFormat:W.VI.RGBA,dataType:W.Br.UNSIGNED_BYTE,wrapMode:W.e8.CLAMP_TO_EDGE,samplingMode:W.cw.LINEAR,flipped:!1,width:i[0],height:i[1]}),this._layerFBOTexture?this._layerFBOTexture.resize(t,r):this._layerFBOTexture=new Be.x(n,{target:W.No.TEXTURE_2D,pixelFormat:W.VI.RGBA,internalFormat:W.VI.RGBA,dataType:W.Br.UNSIGNED_BYTE,wrapMode:W.e8.CLAMP_TO_EDGE,samplingMode:W.cw.LINEAR,flipped:!1,width:t,height:r}))}}]),e}(),He=function(){function e(){(0,o.Z)(this,e),this._size=[0,0],this._layerFBOTexture=null}return(0,u.Z)(e,[{key:"dispose",value:function(){this._layerFBOTexture=(0,v.M2)(this._layerFBOTexture)}},{key:"draw",value:function(e,t,r){var i=t.width,n=t.height;this._createOrResizeResources(e,i,n);var a=e.context,s=e.painter,o=r.amount,u=a.gl,h=this._layerFBOTexture;a.bindFramebuffer(t),t.copyToTexture(0,0,i,n,0,0,h),a.setBlendingEnabled(!0),a.setStencilTestEnabled(!1),a.setDepthTestEnabled(!1),a.setClearColor(0,0,0,0),a.clear(u.COLOR_BUFFER_BIT),s.blitTexture(a,h,W.cw.NEAREST,o)}},{key:"_createOrResizeResources",value:function(e,t,r){var i=e.context;this._layerFBOTexture&&this._size[0]===t&&this._size[1]===r||(this._size[0]=t,this._size[1]=r,this._layerFBOTexture?this._layerFBOTexture.resize(t,r):this._layerFBOTexture=new Be.x(i,{target:W.No.TEXTURE_2D,pixelFormat:W.VI.RGBA,internalFormat:W.VI.RGBA,dataType:W.Br.UNSIGNED_BYTE,wrapMode:W.e8.CLAMP_TO_EDGE,samplingMode:W.cw.NEAREST,flipped:!1,width:t,height:r}))}}]),e}();function qe(e){switch(e){case"bloom":case"blur":case"opacity":case"drop-shadow":return e;default:return"colorize"}}var We={colorize:function(){return new De},blur:function(){return new Ze},bloom:function(){return new Ce},opacity:function(){return new He},"drop-shadow":function(){return new Ve}},je=function(){function e(){(0,o.Z)(this,e),this._effectMap=new Map}return(0,u.Z)(e,[{key:"dispose",value:function(){this._effectMap.forEach((function(e){return e.dispose()})),this._effectMap.clear()}},{key:"getPostProcessingEffects",value:function(e){if(!e||0===e.length)return[];var t,r=[],i=(0,s.Z)(e);try{for(i.s();!(t=i.n()).done;){var n=t.value,a=qe(n.type),o=this._effectMap.get(a);o||(o=We[a](),this._effectMap.set(a,o)),r.push({postProcessingEffect:o,effect:n})}}catch(u){i.e(u)}finally{i.f()}return r}}]),e}(),Xe=r(63780),Ke=function(){function e(t,r){var i;(0,o.Z)(this,e),this.brushes=t,this.name=r.name,this.drawPhase=r.drawPhase||E.jx.MAP,this._targetFn=r.target,this.effects=r.effects||[],this.enableDefaultDraw=null!==(i=r.enableDefaultDraw)&&void 0!==i?i:function(){return!0}}return(0,u.Z)(e,[{key:"render",value:function(e){var t=e.context,r=e.profiler,i=this._targetFn(),n=this.drawPhase&e.drawPhase;if(r.recordPassStart(this.name),n){this.enableDefaultDraw()&&this._doRender(e,i),r.recordPassEnd();var a,o=(0,s.Z)(this.effects);try{for(o.s();!(a=o.n()).done;){var u=a.value;if(u.enable()){var h=u.apply,l=u.args&&u.args(),c=t.getViewport(),d=t.getBoundFramebufferObject(),f=e.passOptions;this._bindEffect(e,h,l),this._doRender(e,i,h.defines),this._drawAndUnbindEffect(e,h,c,d,f,l)}}}catch(_){o.e(_)}finally{o.f()}}}},{key:"_doRender",value:function(e,t,r){if(!(0,v.Wi)(t)){var i,n=e.profiler,a=e.context,o=(0,s.Z)(this.brushes);try{for(o.s();!(i=o.n()).done;){var u=i.value;if(n.recordBrushStart(u.name),(0,v.pC)(u.brushEffect)){var h=a.getViewport(),l=a.getBoundFramebufferObject(),c=e.passOptions;this._bindEffect(e,u.brushEffect),this._drawWithBrush(u,e,t,r),this._drawAndUnbindEffect(e,u.brushEffect,h,l,c)}else this._drawWithBrush(u,e,t,r);n.recordBrushEnd()}}catch(d){o.e(d)}finally{o.f()}}}},{key:"_drawWithBrush",value:function(e,t,r,i){(0,Xe.zG)(r)?(e.prepareState(t,i),e.drawMany(t,r,i)):r.visible&&(e.prepareState(t,i),e.draw(t,r,i))}},{key:"_bindEffect",value:function(e,t,r){e.profiler.recordPassStart(this.name+"."+t.name),t.bind(e,r);var i=t.createOptions(e,r);e.passOptions=i}},{key:"_drawAndUnbindEffect",value:function(e,t,r,i,n,a){var s=e.profiler,o=e.context;e.passOptions=n,s.recordBrushStart(t.name),t.draw(e,a),t.unbind(e,a),o.bindFramebuffer(i);var u=r.x,h=r.y,l=r.width,c=r.height;o.setViewport(u,h,l,c),s.recordBrushEnd(),s.recordPassEnd()}}]),e}(),Ye=r(15880);var Qe=function(){function e(t,r,i){(0,o.Z)(this,e),this.context=t,this._blitRenderer=new K,this._worldExtentClipRenderer=new _e,this._isClippedToWorldExtent=!1,this._brushCache=new Map,this._lastWidth=null,this._lastHeight=null,this._prevFBO=null,this._vtlMaterialManager=new G,this._blendEffect=new ve.k,this._stencilBuf=null,this._fbos=null,this._fboPool=[],this._renderTarget=null,this.effects={highlight:new Fe,hittest:new ke,hittestVTL:new Me,integrate:new ge,insideEffect:new me("inside"),outsideEffect:new me("outside")},this.materialManager=new ee(t),this.textureManager=new te.Z(r,i,t.type===ne.zO.WEBGL2),this.textureUploadManager=new ae(t,r),this._effectsManager=new je}return(0,u.Z)(e,[{key:"vectorTilesMaterialManager",get:function(){return this._vtlMaterialManager}},{key:"getRenderTarget",value:function(){return this._renderTarget}},{key:"setRenderTarget",value:function(e){this._renderTarget=e}},{key:"getFbos",value:function(e,t){if(e!==this._lastWidth||t!==this._lastHeight){if(this._lastWidth=e,this._lastHeight=t,this._fbos){for(var r in this._fbos)this._fbos[r].resize(e,t);return this._fbos}var i={target:W.No.TEXTURE_2D,pixelFormat:W.VI.RGBA,dataType:W.Br.UNSIGNED_BYTE,samplingMode:W.cw.NEAREST,wrapMode:W.e8.CLAMP_TO_EDGE,width:e,height:t},n={colorTarget:W.Lm.TEXTURE,depthStencilTarget:W.OU.DEPTH_STENCIL_RENDER_BUFFER},a=new Ye.r(this.context,{width:e,height:t,internalFormat:W.Tg.DEPTH_STENCIL});this._stencilBuf=a,this._fbos={output:new xe.X(this.context,n,i,a),blend:new xe.X(this.context,n,i,a),effect0:new xe.X(this.context,n,i,a)}}return this._fbos}},{key:"acquireFbo",value:function(e,t){var r,i=(r=this._fboPool.length>0?this._fboPool.pop():new xe.X(this.context,{colorTarget:W.Lm.TEXTURE,depthStencilTarget:W.OU.DEPTH_STENCIL_RENDER_BUFFER},{target:W.No.TEXTURE_2D,pixelFormat:W.VI.RGBA,dataType:W.Br.UNSIGNED_BYTE,samplingMode:W.cw.NEAREST,wrapMode:W.e8.CLAMP_TO_EDGE,width:e,height:t},this._stencilBuf)).descriptor;return i.width===e&&i.height===t||r.resize(e,t),r}},{key:"releaseFbo",value:function(e){this._fboPool.push(e)}},{key:"getSharedStencilBuffer",value:function(){return this._stencilBuf}},{key:"beforeRenderLayers",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=e.getViewport(),i=r.width,n=r.height;this._prevFBO=e.getBoundFramebufferObject();var a=this.getFbos(i,n);if(e.bindFramebuffer(null===a||void 0===a?void 0:a.output),e.setColorMask(!0,!0,!0,!0),(0,v.pC)(t)){var s=t.color,o=s.r,u=s.g,h=s.b,l=s.a;e.setClearColor(l*o/255,l*u/255,l*h/255,l)}else e.setClearColor(0,0,0,0);e.setDepthWriteEnabled(!0),e.setClearDepth(1),e.clear(e.gl.COLOR_BUFFER_BIT|e.gl.DEPTH_BUFFER_BIT),e.setDepthWriteEnabled(!1)}},{key:"beforeRenderLayer",value:function(e,t,r){var i,n=e.context,a=e.blendMode,s=e.effects,o=e.requireFBO,u=e.drawPhase;if(o||Je(u,a,s,r))n.bindFramebuffer(null===(i=this._fbos)||void 0===i?void 0:i.blend),n.setColorMask(!0,!0,!0,!0),n.setClearColor(0,0,0,0),n.setDepthWriteEnabled(!0),n.setClearDepth(1),n.clear(n.gl.COLOR_BUFFER_BIT|n.gl.DEPTH_BUFFER_BIT),n.setDepthWriteEnabled(!1);else{var h=this._getOutputFBO();n.bindFramebuffer(h)}n.setDepthWriteEnabled(!1),n.setDepthTestEnabled(!1),n.setStencilTestEnabled(!0),n.setClearStencil(t),n.setStencilWriteMask(255),n.clear(n.gl.STENCIL_BUFFER_BIT)}},{key:"compositeLayer",value:function(e,t){var r=e.context,i=e.blendMode,n=e.effects,a=e.requireFBO,s=e.drawPhase;if(a||Je(s,i,n,t)){(0,v.pC)(n)&&n.length>0&&s===E.jx.MAP&&this._applyEffects(e,n);var o=this._getOutputFBO();r.bindFramebuffer(o),r.setStencilTestEnabled(!1),r.setStencilWriteMask(0),r.setBlendingEnabled(!0),r.setBlendFunctionSeparate(W.zi.ONE,W.zi.ONE_MINUS_SRC_ALPHA,W.zi.ONE,W.zi.ONE_MINUS_SRC_ALPHA),r.setColorMask(!0,!0,!0,!0);var u=(0,v.Wi)(i)||s===E.jx.HIGHLIGHT?"normal":i,h=this._fbos;(null===h||void 0===h?void 0:h.blend.colorTexture)&&this._blendEffect.draw(e,h.blend.colorTexture,W.cw.NEAREST,u,t)}}},{key:"renderLayers",value:function(e){e.bindFramebuffer(this._prevFBO);var t=this._getOutputFBO();t&&(e.setDepthTestEnabled(!1),e.setStencilWriteMask(0),this._isClippedToWorldExtent?(e.setStencilTestEnabled(!0),e.setStencilFunction(W.wb.EQUAL,1,255)):e.setStencilTestEnabled(!1),this.blitTexture(e,t.colorTexture,W.cw.NEAREST))}},{key:"prepareDisplay",value:function(e,t,r){var i=e.context;if(i.bindFramebuffer(this._prevFBO),i.setColorMask(!0,!0,!0,!0),(0,v.pC)(t)){var n=t.color,a=n.r,s=n.g,o=n.b,u=n.a;i.setClearColor(u*a/255,u*s/255,u*o/255,u)}else i.setClearColor(0,0,0,0);i.setStencilWriteMask(255),i.setClearStencil(0),i.clear(i.gl.COLOR_BUFFER_BIT|i.gl.STENCIL_BUFFER_BIT),this._isClippedToWorldExtent=this._worldExtentClipRenderer.render(e,r)}},{key:"dispose",value:function(){if(this.materialManager.dispose(),this.textureManager.dispose(),this.textureUploadManager.destroy(),this._blitRenderer=(0,v.M2)(this._blitRenderer),this._worldExtentClipRenderer=(0,v.M2)(this._worldExtentClipRenderer),this._brushCache&&(this._brushCache.forEach((function(e){return e.dispose()})),this._brushCache.clear(),this._brushCache=null),this._fbos)for(var e in this._fbos)this._fbos[e]&&this._fbos[e].dispose();var t,r=(0,s.Z)(this._fboPool);try{for(r.s();!(t=r.n()).done;){t.value.dispose()}}catch(n){r.e(n)}finally{r.f()}if(this._fboPool.length=0,this.effects)for(var i in this.effects)this.effects[i]&&this.effects[i].dispose();this._effectsManager.dispose(),this._vtlMaterialManager=(0,v.M2)(this._vtlMaterialManager),this._prevFBO=null}},{key:"getBrush",value:function(e,t){var r=function(e,t){switch(e){case E.LW.LINE:return x.U.line;case E.LW.TEXT:return x.U.text;case E.LW.LABEL:return x.U.label;case E.LW.FILL:return t===E.mD.DOT_DENSITY?x.U.dotDensity:x.U.fill;case E.LW.MARKER:switch(t){case E.mD.HEATMAP:return x.U.heatmap;case E.mD.PIE_CHART:return x.U.pieChart;default:return x.U.marker}}}(e,t),i=this._brushCache.get(r);return void 0===i&&(i=new r,this._brushCache.set(r,i)),i}},{key:"renderObject",value:function(e,t,r,i){var n=x.U[r];if(n){var a=this._brushCache.get(n);void 0===a&&(a=new n,this._brushCache.set(n,a)),a.prepareState(e,i),a.draw(e,t,i)}}},{key:"renderObjects",value:function(e,t,r,i){var n=x.U[r];if(n){var a=this._brushCache.get(n);void 0===a&&(a=new n,this._brushCache.set(n,a)),a.drawMany(e,t,i)}}},{key:"registerRenderPass",value:function(e){var t=this,r=e.brushes.map((function(e){return t._brushCache.has(e)||t._brushCache.set(e,new e),t._brushCache.get(e)}));return new Ke(r,e)}},{key:"blitTexture",value:function(e,t,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(W.zi.ONE,W.zi.ONE_MINUS_SRC_ALPHA,W.zi.ONE,W.zi.ONE_MINUS_SRC_ALPHA),e.setColorMask(!0,!0,!0,!0),this._blitRenderer.render(e,t,r,i)}},{key:"getPostProcessingEffects",value:function(e){return this._effectsManager.getPostProcessingEffects(e)}},{key:"_getOutputFBO",value:function(){var e,t;return null!=this._renderTarget?this._renderTarget:null!==(e=null===(t=this._fbos)||void 0===t?void 0:t.output)&&void 0!==e?e:null}},{key:"_applyEffects",value:function(e,t){var r,i=null===(r=this._fbos)||void 0===r?void 0:r.blend;if(i){var n,a=e.context,o=this._effectsManager.getPostProcessingEffects(t),u=(0,s.Z)(o);try{for(u.s();!(n=u.n()).done;){var h=n.value,l=h.postProcessingEffect,c=h.effect;a.bindFramebuffer(i),l.draw(e,i,c)}}catch(d){u.e(d)}finally{u.f()}}}}]),e}();function Je(e,t,r,i){return e!==E.jx.HIGHLIGHT&&(1!==i||(0,v.pC)(t)&&"normal"!==t||(0,v.pC)(r)&&r.length>0)}var $e=r(13163),et=r(84786),tt=r(7796),rt=r(86401),it=r(51e3),nt=function(e){(0,d.Z)(r,e);var t=(0,f.Z)(r);function r(e,i){var n,a;(0,o.Z)(this,r),(a=t.call(this))._trash=new Set,a._renderRemainingTime=0,a._lastFrameRenderTime=0,a.renderRequested=!1,a.stage=(0,h.Z)(a),a._stationary=!0;var s=i.canvas,u=void 0===s?document.createElement("canvas"):s,l=i.alpha,c=void 0===l||l,d=i.stencil,f=void 0===d||d,b=i.contextOptions,T=void 0===b?{}:b;a._canvas=u;var E=(0,ne.sj)("2d",u,{alpha:c,antialias:!1,depth:!0,stencil:f});a.context=new rt.x(null!==(n=(0,v.Wg)(E))&&void 0!==n?n:null,T),a.resourceManager=new y.Z,a.painter=new Qe(a.context,(0,h.Z)(a),a.resourceManager),(0,g.Z)("esri-2d-profiler")&&(a._debugOutput=document.createElement("div"),a._debugOutput.setAttribute("style","margin: 24px 64px; position: absolute; color: red;"),e.appendChild(a._debugOutput));return a._renderParameters={drawPhase:0,state:a.state,pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1,blendMode:null,deltaTime:-1,time:0,inFadeTransition:!1,effects:null,context:a.context,painter:a.painter,timeline:i.timeline||new et.T,renderingOptions:i.renderingOptions,requestRender:function(){return a.requestRender()},allowDelayedRender:!1,requireFBO:!1,profiler:new $e.Q(a.context,a._debugOutput),dataUploadCounter:0,get highlightGradient(){return a._highlightGradient}},a._taskHandle=(0,m.A)({render:function(e){return a.renderFrame(e)}}),a._taskHandle.pause(),a._lostWebGLContextHandle=(0,p.on)(u,"webglcontextlost",(function(){a.emit("webgl-error",{error:new _.Z("webgl-context-lost")})})),a._bufferPool=new w.Q,u.setAttribute("style","width: 100%; height:100%; display:block;"),e.appendChild(u),a}return(0,u.Z)(r,[{key:"destroy",value:function(){var e,t,r;this.removeAllChildren(),this._emptyTrash(),this._taskHandle=(0,v.hw)(this._taskHandle),this._lostWebGLContextHandle=(0,v.hw)(this._lostWebGLContextHandle),null!==(e=this._canvas.parentNode)&&void 0!==e&&e.removeChild(this._canvas),null!==(t=this._debugOutput)&&void 0!==t&&null!==(r=t.parentNode)&&void 0!==r&&r.removeChild(this._debugOutput),this._bufferPool.destroy(),this.resourceManager.destroy(),this.painter.dispose(),this.context.dispose(),this._canvas=null}},{key:"background",get:function(){return this._background},set:function(e){this._background=e,this.requestRender()}},{key:"bufferPool",get:function(){return this._bufferPool}},{key:"renderingOptions",get:function(){return this._renderingOptions},set:function(e){this._renderingOptions=e,this.requestRender()}},{key:"state",get:function(){return this._state},set:function(e){this._state=e,this.requestRender()}},{key:"stationary",get:function(){return this._stationary},set:function(e){this._stationary!==e&&(this._stationary=e,this.requestRender())}},{key:"trashDisplayObject",value:function(e){this._trash.add(e),this.requestRender()}},{key:"untrashDisplayObject",value:function(e){return this._trash.delete(e)}},{key:"requestRender",value:function(){this._renderRemainingTime=2e3,this.renderRequested||(this.renderRequested=!0,this.emit("will-render"),this._taskHandle.resume())}},{key:"renderFrame",value:function(e){var t=this._lastFrameRenderTime?e.time-this._lastFrameRenderTime:0;this._renderRemainingTime-=t,this._renderRemainingTime<=0&&this._taskHandle.pause(),this._lastFrameRenderTime=e.time,this.renderRequested=!1,this._renderParameters.state=this._state,this._renderParameters.stationary=this.stationary,this._renderParameters.pixelRatio=window.devicePixelRatio,this._renderParameters.globalOpacity=1,this._renderParameters.time=e.time,this._renderParameters.deltaTime=e.deltaTime,this._renderParameters.effects=null,this.processRender(this._renderParameters),this._emptyTrash(),this.emit("post-render")}},{key:"_createTransforms",value:function(){return{dvs:(0,b.c)()}}},{key:"renderChildren",value:function(e){var t,r=(0,s.Z)(this.children);try{for(r.s();!(t=r.n()).done;){t.value.beforeRender(e)}}catch(a){r.e(a)}finally{r.f()}this._renderChildren(this.children,e);var i,n=(0,s.Z)(this.children);try{for(n.s();!(i=n.n()).done;){i.value.afterRender(e)}}catch(a){n.e(a)}finally{n.f()}}},{key:"_renderChildren",value:function(e,t){var r=this.context;this.painter.textureUploadManager.upload(),r.resetInfo(),t.profiler.recordStart("drawLayers"),t.dataUploadCounter=0,t.drawPhase=E.jx.MAP,this.painter.beforeRenderLayers(r,this.background);var i,n=(0,s.Z)(e);try{for(n.s();!(i=n.n()).done;){i.value.processRender(t)}}catch(d){n.e(d)}finally{n.f()}this.painter.prepareDisplay(t,this.background,this.state.padding),this.painter.renderLayers(r),t.drawPhase=E.jx.HIGHLIGHT,this.painter.beforeRenderLayers(r);var a,o=(0,s.Z)(e);try{for(o.s();!(a=o.n()).done;){a.value.processRender(t)}}catch(d){o.e(d)}finally{o.f()}if(this.painter.renderLayers(r),this._isLabelDrawPhaseRequired(e)){t.drawPhase=E.jx.LABEL,this.painter.beforeRenderLayers(r);var u,h=(0,s.Z)(e);try{for(h.s();!(u=h.n()).done;){u.value.processRender(t)}}catch(d){h.e(d)}finally{h.f()}this.painter.renderLayers(r)}if((0,g.Z)("esri-tiles-debug")){t.drawPhase=E.jx.DEBUG,this.painter.beforeRenderLayers(r);var l,c=(0,s.Z)(e);try{for(c.s();!(l=c.n()).done;){l.value.processRender(t)}}catch(d){c.e(d)}finally{c.f()}this.painter.renderLayers(r)}t.profiler.recordEnd("drawLayers"),r.logInfo()}},{key:"doRender",value:function(e){var t=this.context,i=e.state,n=e.pixelRatio;this._resizeCanvas(e),t.setViewport(0,0,n*i.size[0],n*i.size[1]),t.setDepthWriteEnabled(!0),t.setStencilWriteMask(255),(0,l.Z)((0,c.Z)(r.prototype),"doRender",this).call(this,e)}},{key:"takeScreenshot",value:function(){var e=(0,a.Z)((0,i.Z)().mark((function e(t){var r,a,s,o,u,h,l,c,d,f,_,p,g,v;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r={framebufferWidth:Math.round(this.state.size[0]*t.resolutionScale),framebufferHeight:Math.round(this.state.size[1]*t.resolutionScale)},a=r.framebufferWidth,s=r.framebufferHeight,o=t.resolutionScale,u=this.context,h=this._state.clone(),null!=t.rotation&&(l=h.viewpoint,h.viewpoint.rotation=t.rotation,h.viewpoint=l),c=(0,n.Z)((0,n.Z)({},this._renderParameters),{},{drawPhase:null,globalOpacity:1,stationary:!0,state:h,pixelRatio:o,time:performance.now(),deltaTime:0,blendMode:null,effects:null,inFadeTransition:!1}),d=new xe.X(u,{colorTarget:W.Lm.TEXTURE,depthStencilTarget:W.OU.DEPTH_STENCIL_RENDER_BUFFER,width:a,height:s}),f=u.getBoundFramebufferObject(),_=u.getViewport(),u.bindFramebuffer(d),u.setViewport(0,0,a,s),this._renderChildren(t.children,c),p=this._readbackScreenshot(d,(0,n.Z)((0,n.Z)({},t.cropArea),{},{y:s-(t.cropArea.y+t.cropArea.height)})),u.bindFramebuffer(f),u.setViewport(_.x,_.y,_.width,_.height),this.requestRender(),e.next=8,p;case 8:return g=e.sent,e.abrupt("return",(1===t.outputScale?v=g:(v=new ImageData(Math.round(g.width*t.outputScale),Math.round(g.height*t.outputScale)),(0,tt.TT)(g,v,!0)),v));case 10:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_readbackScreenshot",value:function(){var e=(0,a.Z)((0,i.Z)().mark((function e(t,r){var n;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=(0,it.r)(r.width,r.height,document.createElement("canvas")),e.next=3,t.readPixelsAsync(r.x,r.y,r.width,r.height,W.VI.RGBA,W.Br.UNSIGNED_BYTE,new Uint8Array(n.data.buffer));case 3:return e.abrupt("return",n);case 4:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_resizeCanvas",value:function(e){var t=this._canvas,r=t.style,i=e.state.size,n=e.pixelRatio,a=i[0],s=i[1],o=Math.round(a*n),u=Math.round(s*n);t.width===o&&t.height===u||(t.width=o,t.height=u),r.width=a+"px",r.height=s+"px"}},{key:"_emptyTrash",value:function(){for(;this._trash.size>0;){var e=Array.from(this._trash);this._trash.clear();for(var t=0,r=e;t<r.length;t++){r[t].processDetach()}}}},{key:"_isLabelDrawPhaseRequired",value:function(e){var t,r=!1,i=(0,s.Z)(e);try{for(i.s();!(t=i.n()).done;){var n=t.value;if(!(n instanceof T.W)){r=r||!1;break}if(n.hasLabels)return!0;r=r||this._isLabelDrawPhaseRequired(n.children)}}catch(a){i.e(a)}finally{i.f()}return r}}]),r}(T.W),at=r(77234),st=r(34035),ot=r(75391),ut=r(91908),ht=r(76200),lt=r(14921),ct=r(100),dt=r(16889),ft=r(94172),_t=r(35995),pt=r(87422),gt=r(69610),vt=r(38330);function mt(e){return bt.apply(this,arguments)}function bt(){return bt=(0,a.Z)((0,i.Z)().mark((function e(t){var n,a,s,o,u;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.e(3581).then(r.bind(r,83581)),a=r.e(8938).then(r.bind(r,78938)),e.t0=vt.t,e.next=5,n;case 5:return e.t1=e.sent.default,e.t2={signal:t},s=(0,e.t0)(e.t1,e.t2),e.t3=vt.t,e.next=11,a;case 11:return e.t4=e.sent.default,e.t5={signal:t},o=(0,e.t3)(e.t4,e.t5),e.next=16,s;case 16:return e.t6=e.sent,e.next=19,o;case 19:return e.t7=e.sent,u={mask:e.t6,overlay:e.t7},e.abrupt("return",((0,re.k_)(t),u));case 22:case"end":return e.stop()}}),e)}))),bt.apply(this,arguments)}var yt=function(e){(0,d.Z)(r,e);var t=(0,f.Z)(r);function r(){var e;return(0,o.Z)(this,r),(e=t.call(this))._handles=new ct.Z,e._resourcePixelRatio=1,e.visible=!1,e}return(0,u.Z)(r,[{key:"destroy",value:function(){this._handles=(0,v.SC)(this._handles),this._disposeRenderResources(),this._resourcesTask=(0,v.IM)(this._resourcesTask)}},{key:"background",get:function(){return this._background},set:function(e){this._background=e,this.requestRender()}},{key:"magnifier",get:function(){return this._magnifier},set:function(e){var t=this;this._magnifier=e,this._handles.removeAll(),this._handles.add([(0,ft.YP)((function(){return e.version}),(function(){t.visible=e.visible&&(0,v.pC)(e.position)&&e.size>0,t.requestRender()}),ft.nn),(0,ft.YP)((function(){return[e.maskUrl,e.overlayUrl]}),(function(){return t._reloadResources()})),(0,ft.YP)((function(){return e.size}),(function(){t._disposeRenderResources(),t.requestRender()}))])}},{key:"_createTransforms",value:function(){return{dvs:(0,b.c)()}}},{key:"doRender",value:function(e){var t,r=e.context;if(this._resourcesTask){if(e.drawPhase===E.jx.MAP&&this._canRender()){this._updateResources(e);var i=this._magnifier;if(!(0,v.Wi)(i.position)){var n=e.pixelRatio,a=i.size*n,s=1/i.factor,o=Math.ceil(s*a);this._readbackTexture.resize(o,o);var u=e.state.size,h=n*u[0],l=n*u[1],c=.5*o,d=.5*o,f=(0,dt.uZ)(n*i.position.x,c,h-c-1),_=(0,dt.uZ)(l-n*i.position.y,d,l-d-1);r.setBlendingEnabled(!0);var p=f-c,g=_-d,m=this._readbackTexture;r.bindTexture(m,0),r.gl.copyTexImage2D(m.descriptor.target,0,m.descriptor.pixelFormat,p,g,o,o,0);var b=null===(t=this.background)||void 0===t?void 0:t.color,y=b?[b.a*b.r/255,b.a*b.g/255,b.a*b.b/255,b.a]:[1,1,1,1],T=(f+i.offset.x*n)/h*2-1,w=(_-i.offset.y*n)/l*2-1,x=a/h*2,B=a/l*2,R=this._program;r.bindVAO(this._vertexArrayObject),r.bindTexture(this._overlayTexture,6),r.bindTexture(this._maskTexture,7),r.useProgram(R),R.setUniform4fv("u_background",y),R.setUniform1i("u_readbackTexture",0),R.setUniform1i("u_overlayTexture",6),R.setUniform1i("u_maskTexture",7),R.setUniform4f("u_drawPos",T,w,x,B),R.setUniform1i("u_maskEnabled",i.maskEnabled?1:0),R.setUniform1i("u_overlayEnabled",i.overlayEnabled?1:0),r.setStencilTestEnabled(!1),r.setColorMask(!0,!0,!0,!0),r.drawArrays(W.MX.TRIANGLE_STRIP,0,4),r.bindVAO()}}}else this._reloadResources()}},{key:"_canRender",value:function(){return this.mask&&this.overlay&&null!=this._magnifier}},{key:"_reloadResources",value:function(){var e=this;this._resourcesTask&&this._resourcesTask.abort();var t=(0,v.pC)(this._magnifier)?this._magnifier.maskUrl:null,r=(0,v.pC)(this._magnifier)?this._magnifier.overlayUrl:null;this._resourcesTask=(0,lt.vr)(function(){var n=(0,a.Z)((0,i.Z)().mark((function n(a){var s,o,u,h,l,c,d;return(0,i.Z)().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return s=(0,v.Wi)(t)||(0,v.Wi)(r)?mt(a):null,o=(0,v.pC)(t)?(0,ht.default)(t,{responseType:"image",signal:a}).then((function(e){return e.data})):s.then((function(e){return e.mask})),u=(0,v.pC)(r)?(0,ht.default)(r,{responseType:"image",signal:a}).then((function(e){return e.data})):s.then((function(e){return e.overlay})),i.next=5,Promise.all([o,u]);case 5:h=i.sent,l=(0,Ee.Z)(h,2),c=l[0],d=l[1],e.mask=c,e.overlay=d,e._disposeRenderResources(),e.requestRender();case 10:case"end":return i.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}())}},{key:"_disposeRenderResources",value:function(){this._readbackTexture=(0,v.M2)(this._readbackTexture),this._overlayTexture=(0,v.M2)(this._overlayTexture),this._maskTexture=(0,v.M2)(this._maskTexture),this._vertexArrayObject=(0,v.M2)(this._vertexArrayObject),this._program=(0,v.M2)(this._program)}},{key:"_updateResources",value:function(e){if(e.pixelRatio!==this._resourcePixelRatio&&this._disposeRenderResources(),!this._readbackTexture){var t=e.context;this._resourcePixelRatio=e.pixelRatio;var r=Math.ceil(this._magnifier.size*e.pixelRatio);this._program=(0,gt.F)(t);var i=new Uint16Array([0,1,0,0,1,1,1,0]),n=gt.c.attributes;this._vertexArrayObject=new X.U(t,n,V.cD,{geometry:q.f.createVertex(t,W.l1.STATIC_DRAW,i)}),this.overlay.width=r,this.overlay.height=r,this._overlayTexture=new Be.x(t,{target:W.No.TEXTURE_2D,pixelFormat:W.VI.RGBA,internalFormat:W.VI.RGBA,dataType:W.Br.UNSIGNED_BYTE,wrapMode:W.e8.CLAMP_TO_EDGE,samplingMode:W.cw.NEAREST,flipped:!0,preMultiplyAlpha:!(0,_t.zd)(this.overlay.src)||!e.context.driverTest.svgPremultipliesAlpha.result},this.overlay),this.mask.width=r,this.mask.height=r,this._maskTexture=new Be.x(t,{target:W.No.TEXTURE_2D,pixelFormat:W.VI.ALPHA,internalFormat:W.VI.ALPHA,dataType:W.Br.UNSIGNED_BYTE,wrapMode:W.e8.CLAMP_TO_EDGE,samplingMode:W.cw.NEAREST,flipped:!0},this.mask);var a=1/this._magnifier.factor;this._readbackTexture=new Be.x(t,{target:W.No.TEXTURE_2D,pixelFormat:W.VI.RGBA,internalFormat:W.VI.RGBA,dataType:W.Br.UNSIGNED_BYTE,wrapMode:W.e8.CLAMP_TO_EDGE,samplingMode:W.cw.LINEAR,flipped:!1,width:Math.ceil(a*r),height:Math.ceil(a*r)})}}}]),r}(pt.s)}}]);
//# sourceMappingURL=8499.8c2c7589.chunk.js.map