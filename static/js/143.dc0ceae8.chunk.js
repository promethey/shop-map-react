"use strict";(self.webpackChunkshop_map_react=self.webpackChunkshop_map_react||[]).push([[143],{58971:function(e,t,r){r.d(t,{G6:function(){return R},Ie:function(){return w},J9:function(){return x},RF:function(){return _},U1:function(){return Z},vY:function(){return l},ym:function(){return b}});var n=r(29439),i=r(92026),a=r(77981);var s=function(e,t,r){return[t,r]},u=function(e,t,r){return[t,r,e[2]]},o=function(e,t,r){return[t,r,e[2],e[3]]};function l(e){return e?{originPosition:"upper-left"===e.originPosition?"upperLeft":"lower-left"===e.originPosition?"lowerLeft":e.originPosition,scale:e.tolerance?[e.tolerance,e.tolerance]:[1,1],translate:(0,i.pC)(e.extent)?[e.extent.xmin,e.extent.ymax]:[0,0]}:null}function c(e,t){var r=e.scale,n=e.translate;return Math.round((t-n[0])/r[0])}function p(e,t){var r=e.scale,n=e.translate;return Math.round((n[1]-t)/r[1])}function f(e,t,r){for(var n,i,a,s,u=[],o=0;o<r.length;o++){var l=r[o];o>0?(a=c(e,l[0]),s=p(e,l[1]),a===n&&s===i||(u.push(t(l,a-n,s-i)),n=a,i=s)):(n=c(e,l[0]),i=p(e,l[1]),u.push(t(l,n,i)))}return u.length>0?u:null}function d(e,t){var r=e.scale,n=e.translate;return t*r[0]+n[0]}function h(e,t){var r=e.scale;return e.translate[1]-t*r[1]}function y(e,t,r){var i=new Array(r.length);if(!r.length)return i;var a=(0,n.Z)(e.scale,2),s=a[0],u=a[1],o=d(e,r[0][0]),l=h(e,r[0][1]);i[0]=t(r[0],o,l);for(var c=1;c<r.length;c++){var p=r[c];o+=p[0]*s,l-=p[1]*u,i[c]=t(p,o,l)}return i}function v(e,t,r){for(var n=new Array(r.length),i=0;i<r.length;i++)n[i]=y(e,t,r[i]);return n}function g(e,t,r,n,i){var a;return t.points=null!==(a=function(e,t,r,n){return f(e,r?n?o:u:n?u:s,t)}(e,r.points,n,i))&&void 0!==a?a:[],t}function _(e,t,r,n,i){return t.x=c(e,r.x),t.y=p(e,r.y),t!==r&&(n&&(t.z=r.z),i&&(t.m=r.m)),t}function m(e,t,r,n,i){var a=function(e,t,r,n){for(var i=[],a=r?n?o:u:n?u:s,l=0;l<t.length;l++){var c=f(e,a,t[l]);c&&c.length>=3&&i.push(c)}return i.length?i:null}(e,r.rings,n,i);return a?(t.rings=a,t):null}function k(e,t,r,n,i){var a=function(e,t,r,n){for(var i=[],a=r?n?o:u:n?u:s,l=0;l<t.length;l++){var c=f(e,a,t[l]);c&&c.length>=2&&i.push(c)}return i.length?i:null}(e,r.paths,n,i);return a?(t.paths=a,t):null}function b(e,t){return e&&t?(0,a.wp)(t)?_(e,{},t,!1,!1):(0,a.l9)(t)?k(e,{},t,!1,!1):(0,a.oU)(t)?m(e,{},t,!1,!1):(0,a.aW)(t)?g(e,{},t,!1,!1):(0,a.YX)(t)?function(e,t,r,n,i){return t.xmin=c(e,r.xmin),t.ymin=p(e,r.ymin),t.xmax=c(e,r.xmax),t.ymax=p(e,r.ymax),t!==r&&(n&&(t.zmin=r.zmin,t.zmax=r.zmax),i&&(t.mmin=r.mmin,t.mmax=r.mmax)),t}(e,{},t,!1,!1):null:null}function x(e,t,r,n,a){return(0,i.pC)(r)&&(t.points=function(e,t,r,n){return y(e,r?n?o:u:n?u:s,t)}(e,r.points,n,a)),t}function Z(e,t,r,n,a){return(0,i.Wi)(r)||(t.x=d(e,r.x),t.y=h(e,r.y),t!==r&&(n&&(t.z=r.z),a&&(t.m=r.m))),t}function w(e,t,r,n,a){return(0,i.pC)(r)&&(t.rings=function(e,t,r,n){return v(e,r?n?o:u:n?u:s,t)}(e,r.rings,n,a)),t}function R(e,t,r,n,a){return(0,i.pC)(r)&&(t.paths=function(e,t,r,n){return v(e,r?n?o:u:n?u:s,t)}(e,r.paths,n,a)),t}},87072:function(e,t,r){function n(e){var t,r=e.layer;return"floorInfo"in r&&null!==(t=r.floorInfo)&&void 0!==t&&t.floorField&&"floors"in e.view?a(e.view.floors,r.floorInfo.floorField):null}function i(e,t){var r;return"floorInfo"in t&&null!==(r=t.floorInfo)&&void 0!==r&&r.floorField?a(e,t.floorInfo.floorField):null}function a(e,t){if(null===e||void 0===e||!e.length)return null;var r=e.filter((function(e){return""!==e})).map((function(e){return"'".concat(e,"'")}));return r.push("''"),"".concat(t," IN (").concat(r.join(","),") OR ").concat(t," IS NULL")}r.d(t,{c:function(){return n},f:function(){return i}})},50244:function(e,t,r){r.r(t),r.d(t,{default:function(){return Ze}});var n=r(37762),i=r(1413),a=r(93433),s=r(74165),u=r(15861),o=r(15671),l=r(43144),c=r(60136),p=r(29388),f=r(27366),d=r(52639),h=r(49861),y=(r(25243),r(63780),r(69912)),v=function(e){(0,c.Z)(r,e);var t=(0,p.Z)(r);function r(){var e;return(0,o.Z)(this,r),(e=t.apply(this,arguments)).isAggregate=!0,e}return(0,l.Z)(r,[{key:"getEffectivePopupTemplate",value:function(){if(this.popupTemplate)return this.popupTemplate;var e=this.sourceLayer&&this.sourceLayer.featureReduction;return e&&"popupTemplate"in e&&e.popupEnabled?e.popupTemplate:null}},{key:"getObjectId",value:function(){return this.attributes.aggregateId}}]),r}(d.Z);(0,f._)([(0,h.Cb)({type:Boolean})],v.prototype,"isAggregate",void 0);var g=v=(0,f._)([(0,y.j)("esri.AggregateGraphic")],v),_=(r(59486),r(40281)),m=r(10064),k=r(93169),b=r(84652),x=r(32718),Z=r(92026),w=r(66978),R=r(94172),C=r(85015),F=r(41978),S=function(e){(0,c.Z)(r,e);var t=(0,p.Z)(r);function r(e){var n;return(0,o.Z)(this,r),(n=t.call(this,e))._filter=null,n.duration=(0,k.Z)("mapview-transitions-duration"),n._excludedEffectView=new F.AM(e),n._includedEffectView=new F.AM(e),n}return(0,l.Z)(r,[{key:"excludedEffects",get:function(){return this._excludedEffectView.effects}},{key:"featureEffect",set:function(e){this._get("featureEffect")!==e&&this._transitionTo(e)}},{key:"filter",get:function(){var e;return this._filter||(null===(e=(0,Z.Wg)(this.featureEffect))||void 0===e?void 0:e.filter)||null}},{key:"hasEffects",get:function(){return this._excludedEffectView.hasEffects||this._includedEffectView.hasEffects}},{key:"includedEffects",get:function(){return this._includedEffectView.effects}},{key:"scale",set:function(e){this._set("scale",e),this._excludedEffectView.scale=e,this._includedEffectView.scale=e}},{key:"transitioning",get:function(){return this._excludedEffectView.transitioning||this._includedEffectView.transitioning}},{key:"transitionStep",value:function(e,t){this._set("scale",t),this.transitioning?(this._includedEffectView.transitionStep(e,t),this._excludedEffectView.transitionStep(e,t),this.transitioning||(this._filter=null)):(this._excludedEffectView.scale=t,this._includedEffectView.scale=t)}},{key:"endTransitions",value:function(){this._includedEffectView.endTransitions(),this._excludedEffectView.endTransitions(),this._filter=null}},{key:"_transitionTo",value:function(e){var t=this._get("featureEffect"),r=(0,Z.Wg)(e),n=(0,Z.Wg)(null===r||void 0===r?void 0:r.includedEffect),i=(0,Z.Wg)(null===r||void 0===r?void 0:r.excludedEffect),a=this._includedEffectView.canTransitionTo(n)&&this._excludedEffectView.canTransitionTo(i);this._includedEffectView.effect=n,this._excludedEffectView.effect=i,this._set("featureEffect",r),this._filter=(null===r||void 0===r?void 0:r.filter)||(null===t||void 0===t?void 0:t.filter)||null,a||this.endTransitions()}}]),r}(C.Z);(0,f._)([(0,h.Cb)()],S.prototype,"_filter",void 0),(0,f._)([(0,h.Cb)()],S.prototype,"_excludedEffectView",void 0),(0,f._)([(0,h.Cb)()],S.prototype,"_includedEffectView",void 0),(0,f._)([(0,h.Cb)()],S.prototype,"duration",void 0),(0,f._)([(0,h.Cb)()],S.prototype,"excludedEffects",null),(0,f._)([(0,h.Cb)()],S.prototype,"featureEffect",null),(0,f._)([(0,h.Cb)()],S.prototype,"filter",null),(0,f._)([(0,h.Cb)()],S.prototype,"hasEffects",null),(0,f._)([(0,h.Cb)()],S.prototype,"includedEffects",null),(0,f._)([(0,h.Cb)({value:0})],S.prototype,"scale",null),(0,f._)([(0,h.Cb)()],S.prototype,"transitioning",null);var q=S=(0,f._)([(0,y.j)("esri.layers.effects.FeatureEffectView")],S),E=r(18661),I=r(37933),O=r(38511),T=r(49818),U=r(78952),A=function(e){(0,c.Z)(r,e);var t=(0,p.Z)(r);function r(){var e;return(0,o.Z)(this,r),(e=t.apply(this,arguments)).features=[],e}return(0,l.Z)(r,[{key:"readFeatures",value:function(e,t){for(var r=U.Z.fromJSON(t.spatialReference),n=[],i=0;i<e.length;i++){var a=e[i],s=g.fromJSON(a),u=a.geometry&&a.geometry.spatialReference;(0,Z.pC)(s.geometry)&&!u&&(s.geometry.spatialReference=r);var o=a.aggregateGeometries,l=s.aggregateGeometries;if(o&&(0,Z.pC)(l))for(var c in l){var p,f=l[c],d=null===(p=o[c])||void 0===p?void 0:p.spatialReference;(0,Z.pC)(f)&&!d&&(f.spatialReference=r)}n.push(s)}return n}}]),r}(T.Z);(0,f._)([(0,h.Cb)({type:[g],json:{write:!0}})],A.prototype,"features",void 0),(0,f._)([(0,O.r)("features")],A.prototype,"readFeatures",null);var V=A=(0,f._)([(0,y.j)("esri.rest.support.AggregateFeatureSet")],A),P=r(21149),N=r(94109),J=r(95986),L=r(69534);function z(e,t){return Q.apply(this,arguments)}function Q(){return Q=(0,u.Z)((0,s.Z)().mark((function e(t,n){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return",null);case 2:e.t0=t.type,e.next="symbol"===e.t0?5:"heatmap"===e.t0?10:15;break;case 5:return e.next=7,Promise.all([r.e(2029),r.e(7394),r.e(3880),r.e(4510),r.e(483),r.e(7957)]).then(r.bind(r,47497));case 7:return e.t1=e.sent.default,e.t2=n,e.abrupt("return",new e.t1(e.t2));case 10:return e.next=12,Promise.all([r.e(2029),r.e(7394),r.e(3880),r.e(4510),r.e(6598)]).then(r.bind(r,46598));case 12:return e.t3=e.sent.default,e.t4=n,e.abrupt("return",new e.t3(e.t4));case 15:case"end":return e.stop()}}),e)}))),Q.apply(this,arguments)}var H=r(65760),j=r(20478),M=r(38164);function B(e){return e.some((function(e){return e.globalId}))}function D(e){return e.filter((function(e){return!e.error})).map((function(e){var t;return null!==(t=e.objectId)&&void 0!==t?t:e.globalId})).filter((function(e){return null!=e}))}function G(e,t){var r,i=new Set(e),a=(0,n.Z)(t.values());try{for(a.s();!(r=a.n()).done;){var s=r.value;i.add(s)}}catch(u){a.e(u)}finally{a.f()}return i}function W(e,t){var r,i=new Set(e),a=(0,n.Z)(t.values());try{for(a.s();!(r=a.n()).done;){var s=r.value;i.delete(s)}}catch(u){a.e(u)}finally{a.f()}return i}var K=function(e){(0,c.Z)(r,e);var t=(0,p.Z)(r);function r(e){var n;return(0,o.Z)(this,r),(n=t.call(this,e))._hasGlobalIds=!1,n._notifyUpdating=function(){n.notifyChange("updating")},n}return(0,l.Z)(r,[{key:"normalizeCtorArgs",value:function(e){return this._queueProcessor=new M.e({concurrency:1,process:e.process}),{}}},{key:"destroy",value:function(){this.clear()}},{key:"updating",get:function(){return this._queueProcessor.length>0}},{key:"clear",value:function(){this._queueProcessor.clear()}},{key:"push",value:function(e){var t=this._queueProcessor,r=t.last();switch(e.type){case"update":case"refresh":if((null===r||void 0===r?void 0:r.type)===e.type)return;t.push(e).then(this._notifyUpdating,this._notifyUpdating);break;case"edit":var i="processed-edit"===(null===r||void 0===r?void 0:r.type)?r:null;i&&t.popLast();var a,s=this._mergeEdits(i,e),u=(0,n.Z)(s);try{for(u.s();!(a=u.n()).done;){var o=a.value;o&&t.push(o).then(this._notifyUpdating,this._notifyUpdating)}}catch(l){u.e(l)}finally{u.f()}}this.notifyChange("updating")}},{key:"_mergeEdits",value:function(e,t){var r,n,i=t.edits,s=i.addedFeatures,u=i.deletedFeatures,o=i.updatedFeatures;if(this._hasGlobalIds=this._hasGlobalIds||B(s)||B(o)||B(u),this._hasGlobalIds)return[e,{type:"processed-edit",edits:{addOrModified:[].concat((0,a.Z)(s),(0,a.Z)(o)),removed:u}}];var l=new Set(D(null!==(r=null===e||void 0===e?void 0:e.edits.addOrModified)&&void 0!==r?r:[])),c=new Set(D(null!==(n=null===e||void 0===e?void 0:e.edits.removed)&&void 0!==n?n:[])),p=new Set([].concat((0,a.Z)(D(s)),(0,a.Z)(D(o)))),f=new Set(D(u));return[{type:"processed-edit",edits:{addOrModified:Array.from(G(W(l,f),p)).map((function(e){return{objectId:e}})),removed:Array.from(G(W(c,p),f)).map((function(e){return{objectId:e}}))}}]}}]),r}(C.Z);(0,f._)([(0,h.Cb)({readOnly:!0})],K.prototype,"updating",null),(0,f._)([(0,h.Cb)()],K.prototype,"process",void 0);var Y=K=(0,f._)([(0,y.j)("esri.views.2d.layers.support.FeatureCommandQueue")],K),X=r(67426),$=r(31009);function ee(e){return Array.isArray(e)}var te=function(e){(0,c.Z)(r,e);var t=(0,p.Z)(r);function r(e){var n;return(0,o.Z)(this,r),(n=t.call(this,e))._startupResolver=(0,w.hh)(),n.isReady=!1,n}return(0,l.Z)(r,[{key:"initialize",value:function(){this._controller=new AbortController,this.addResolvingPromise(this._startWorker(this._controller.signal))}},{key:"destroy",value:function(){this._controller.abort(),this._connection&&this._connection.close()}},{key:"tileRenderer",set:function(e){this.client.tileRenderer=e}},{key:"closed",get:function(){return this._connection.closed}},{key:"startup",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,r,n,i){var a,u,o;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.when();case 2:return a=this._controller.signal,u=ee(n.source)?{transferList:n.source,signal:a}:void 0,o={service:n,config:r,tileInfo:t.tileInfo.toJSON(),tiles:i},e.next=5,this._connection.invoke("startup",o,u);case 5:this._startupResolver.resolve(),this._set("isReady",!0);case 7:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i){return e.apply(this,arguments)}}()},{key:"updateTiles",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",(0,w.R8)(this._connection.invoke("updateTiles",t)));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"update",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r={config:t},e.next=3,this._startupResolver.promise;case 3:return e.abrupt("return",this._connection.invoke("update",r));case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"applyUpdate",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("applyUpdate",t));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"setHighlight",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",(0,w.R8)(this._connection.invoke("controller.setHighlight",t)));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"stop",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:if(this.closed){e.next=4;break}return e.abrupt("return",(0,w.R8)(this._connection.invoke("stop")));case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"refresh",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",(0,w.R8)(this._connection.invoke("controller.refresh",t)));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"querySummaryStatistics",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,r,n){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.querySummaryStatistics",{query:t.toJSON(),params:r},n));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"queryAggregateSummaryStatistics",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,r,n){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.queryAggregateSummaryStatistics",{query:t.toJSON(),params:r},n));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"queryUniqueValues",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,r,n){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.queryUniqueValues",{query:t.toJSON(),params:r},n));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"queryAggregateUniqueValues",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,r,n){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.queryAggregateUniqueValues",{query:t.toJSON(),params:r},n));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"queryClassBreaks",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,r,n){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.queryClassBreaks",{query:t.toJSON(),params:r},n));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"queryAggregateClassBreaks",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,r,n){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.queryAggregateClassBreaks",{query:t.toJSON(),params:r},n));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"queryHistogram",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,r,n){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.queryHistogram",{query:t.toJSON(),params:r},n));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"queryAggregateHistogram",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,r,n){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.queryAggregateHistogram",{query:t.toJSON(),params:r},n));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"queryFeatures",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,r){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.queryFeatures",null===t||void 0===t?void 0:t.toJSON(),r));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"queryVisibleFeatures",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,r){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.queryVisibleFeatures",null===t||void 0===t?void 0:t.toJSON(),r));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"queryObjectIds",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,r){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.queryObjectIds",null===t||void 0===t?void 0:t.toJSON(),r));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"queryFeatureCount",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,r){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.queryFeatureCount",null===t||void 0===t?void 0:t.toJSON(),r));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"queryExtent",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,r){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._connection.invoke("controller.queryExtent",t.toJSON(),r));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"queryLatestObservations",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,r){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.queryLatestObservations",t.toJSON(),r));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"queryStatistics",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.queryStatistics",t));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"queryAggregates",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,r){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.queryAggregates",null===t||void 0===t?void 0:t.toJSON(),r));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"queryAggregateCount",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,r){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.queryAggregateCount",null===t||void 0===t?void 0:t.toJSON(),r));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"queryAggregateIds",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,r){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.queryAggregateIds",null===t||void 0===t?void 0:t.toJSON(),r));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"getObjectId",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.getObjectId",t));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getDisplayId",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.getDisplayId",t));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getFeatures",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.getFeatures",t));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getAggregates",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.getAggregates"));case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"getAggregateValueRanges",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.getAggregateValueRanges"));case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"mapValidDisplayIds",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.mapValidDisplayIds",t));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"onEdits",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",(0,w.R8)(this._connection.invoke("controller.onEdits",t)));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"enableEvent",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,r){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",(0,w.R8)(this._connection.invoke("controller.enableEvent",{name:t,value:r})));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"pauseStream",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",(0,w.R8)(this._connection.invoke("controller.pauseStream")));case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"resumeStream",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",(0,w.R8)(this._connection.invoke("controller.resumeStream")));case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"sendMessageToSocket",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",(0,w.R8)(this._connection.invoke("controller.sendMessageToSocket",t)));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"sendMessageToClient",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",(0,w.R8)(this._connection.invoke("controller.sendMessageToClient",t)));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"updateCustomParameters",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",(0,w.R8)(this._connection.invoke("controller.updateCustomParameters",t)));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_startWorker",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,(0,$.bA)("Pipeline",{client:this.client,strategy:"dedicated",signal:t});case 3:this._connection=e.sent,e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),(0,w.H9)(e.t0);case 9:case"end":return e.stop()}}),e,this,[[0,6]])})));return function(t){return e.apply(this,arguments)}}()}]),r}(X.D);(0,f._)([(0,h.Cb)()],te.prototype,"isReady",void 0),(0,f._)([(0,h.Cb)({constructOnly:!0})],te.prototype,"client",void 0),(0,f._)([(0,h.Cb)()],te.prototype,"tileRenderer",null);var re=te=(0,f._)([(0,y.j)("esri.views.2d.layers.support.FeatureLayerProxy")],te),ne=r(31666),ie=r(48790),ae=r(73828),se=function(){function e(t){(0,o.Z)(this,e),this._tiles=new Map,this.buffer=0,this.acquireTile=t.acquireTile,this.releaseTile=t.releaseTile,this.tileInfoView=t.tileInfoView,this.buffer=t.buffer}return(0,l.Z)(e,[{key:"destroy",value:function(){}},{key:"clear",value:function(){var e=this;this._tiles.forEach((function(t){return e._releaseTile(t)}))}},{key:"tileKeys",value:function(){var e=[];return this._tiles.forEach((function(t,r){return e.push(r)})),e}},{key:"update",value:function(e){var t,r=this,i=this.tileInfoView.getTileCoverage(e.state,this.buffer,"closest"),a=i.spans,s=i.lodInfo,u=s.level,o=[],l=[],c=new Set,p=new Set,f=(0,n.Z)(a);try{for(f.s();!(t=f.n()).done;)for(var d=t.value,h=d.row,y=d.colFrom,v=d.colTo,g=y;g<=v;g++){var _=ae.Z.getId(u,h,s.normalizeCol(g),s.getWorldForColumn(g)),m=this._getOrAcquireTile(o,_);c.add(_),m.isReady?m.visible=!0:p.add(m.key)}}catch(k){f.e(k)}finally{f.f()}return p.forEach((function(e){return r._addPlaceholders(c,e)})),this._tiles.forEach((function(e){c.has(e.key.id)||(l.push(e.key.id),r._releaseTile(e))})),ie.Z.pool.release(i),{hasMissingTiles:p.size>0,added:o,removed:l}}},{key:"_getOrAcquireTile",value:function(e,t){if(!this._tiles.has(t)){var r=this.acquireTile(new ae.Z(t));e.push(t),this._tiles.set(t,r),r.visible=!1}return this._tiles.get(t)}},{key:"_getTile",value:function(e){return this._tiles.get(e)}},{key:"_releaseTile",value:function(e){this._tiles.delete(e.key.id),this.releaseTile(e)}},{key:"_addPlaceholders",value:function(e,t){var r=this._addPlaceholderChildren(e,t);Math.abs(1-r)<1e-6||this._addPlaceholderParent(e,t)||(this._getTile(t.id).visible=!0)}},{key:"_addPlaceholderChildren",value:function(e,t){var r=this,n=0;return this._tiles.forEach((function(i){n+=r._addPlaceholderChild(e,i,t)})),n}},{key:"_addPlaceholderChild",value:function(e,t,r){return t.key.level<=r.level||!t.hasData||!r.contains(t.key)?0:(t.visible=!0,e.add(t.key.id),1/(1<<2*(t.key.level-r.level)))}},{key:"_addPlaceholderParent",value:function(e,t){for(var r=t.getParentKey(),i=0,a=null;(0,Z.pC)(r);){if(e.has(r.id))return!0;var s=this._getTile(r.id);if(null!==s&&void 0!==s&&s.isReady){var u,o=(0,n.Z)(e);try{for(o.s();!(u=o.n()).done;){var l=u.value,c=this._getTile(l);c&&r.contains(c.key)&&(c.visible=!1)}}catch(p){o.e(p)}finally{o.f()}return s.visible=!0,e.add(s.key.id),!0}null!==s&&void 0!==s&&s.hasData&&s.patchCount>i&&(i=s.patchCount,a=s),r=r.getParentKey()}return!!a&&(a.visible=!0,e.add(a.key.id),!0)}}]),e}(),ue=r(11752),oe=r(61120),le=r(45948),ce=r(83444),pe=r(80031),fe=r(87072),de=r(819),he=r(24405),ye="esri.views.layers.FeatureLayerView",ve=x.Z.getLogger(ye),ge=r(67581),_e=r(13107),me=r(90316),ke=r(53866);function be(e){return e&&"openPorts"in e}var xe=function(e){(0,c.Z)(r,e);var t=(0,p.Z)(r);function r(){var e;return(0,o.Z)(this,r),(e=t.apply(this,arguments))._pipelineIsUpdating=!0,e._commandsQueue=new Y({process:function(t){switch(t.type){case"processed-edit":return e._doEdit(t);case"refresh":return e._doRefresh(t.dataChanged);case"update":return e._doUpdate()}}}),e._visibilityOverrides=new Set,e._highlightIds=new Map,e._updateHighlight=(0,w.Ds)((0,u.Z)((0,s.Z)().mark((function t(){return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",e._proxy.setHighlight(Array.from(e._highlightIds.keys())));case 1:case"end":return t.stop()}}),t)})))),e._uploadsLocked=!1,e._needsClusterSizeUpdate=!1,e.featureEffectView=new q,e._lastDefinitionExpression=null,e}return(0,l.Z)(r,[{key:"destroy",value:function(){var e;(0,Z.yw)(this._updateClusterSizeTask,(function(e){return e.remove()})),null!==(e=this._proxy)&&void 0!==e&&e.destroy(),this._commandsQueue.destroy()}},{key:"initialize",value:function(){var e=this;this.addResolvingPromise(Promise.all([this._initProxy(),this._initServiceOptions()])),this.addHandles([this.on("valueRangesChanged",(function(t){e._set("_aggregateValueRanges",t.valueRanges)})),(0,R.YP)((function(){return e.featureEffect}),(function(t){e.featureEffectView.featureEffect=t}),R.tX)],"constructor"),this.featureEffectView.endTransitions()}},{key:"_initProxy",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,r,n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!("isTable"in(r=this.layer))||!r.isTable){e.next=3;break}throw new m.Z("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:this.layer});case 3:if("feature"!==r.type&&"subtype-group"!==r.type||null!==(t=(0,I.S1)(r))&&void 0!==t&&t.operations.supportsQuery){e.next=5;break}throw new m.Z("featurelayerview:query-not-supported","layer view requires a layer with query capability",{layer:r});case 5:return this._proxy&&this._proxy.destroy(),n=this._createClientOptions(),e.abrupt("return",(this._set("_proxy",new re({client:n})),this._proxy.when()));case 8:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_initServiceOptions",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=this,e.next=3,this._createServiceOptions();case 3:return e.t1=e.sent,e.t0._set.call(e.t0,"_serviceOptions",e.t1),e.abrupt("return",this._serviceOptions);case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_effectiveFeatureReduction",get:function(){if(!("featureReduction"in this.layer))return null;var e=this.layer.featureReduction;return e&&(!("maxScale"in e)||!e.maxScale||e.maxScale<this.view.scale)?e:null}},{key:"orderByFields",get:function(){var e,t;return"stream"!==(null===(e=this._serviceOptions)||void 0===e?void 0:e.type)?null===(t=this._serviceOptions)||void 0===t?void 0:t.orderByFields:void 0}},{key:"labelsVisible",get:function(){var e="subtype-group"===this.layer.type?this.layer.sublayers.items:[this.layer];return!this.suspended&&e.some((function(e){return e.labelingInfo&&e.labelsVisible}))}},{key:"queryMode",get:function(){var e;return null===(e=this._serviceOptions)||void 0===e?void 0:e.type}},{key:"renderingConfigHash",get:function(){var e,t;if(!this.layer)return null;var r=this.availableFields,n=this.layer,i=this.view.floors,a=n.definitionExpression,s="subtype-group"!==this.layer.type&&this.layer.labelsVisible&&this.layer.labelingInfo,u="renderer"in n&&n.renderer,o="gdbVersion"in n?n.gdbVersion:void 0,l="historicMoment"in n?null===(e=n.historicMoment)||void 0===e?void 0:e.getTime():void 0,c=this.timeExtent,p="customParameters"in n?JSON.stringify(n.customParameters):void 0,f="apiKey"in n?n.apiKey:void 0,d="stream"===n.type?"".concat(JSON.stringify(n.geometryDefinition)).concat(n.definitionExpression):null,h=JSON.stringify(this.clips),y=null===(t=this._effectiveFeatureReduction)||void 0===t?void 0:t.toJSON(),v="orderBy"in this.layer&&JSON.stringify(this.layer.orderBy),g="sublayers"in this.layer&&this.layer.sublayers.items.reduce((function(e,t){return e+"".concat(t.visible?1:0,".").concat(JSON.stringify(t.renderer),".").concat(t.labelsVisible,"\n.").concat(JSON.stringify(t.labelingInfo))}),""),_="subtypeCode"in this.layer&&this.layer.subtypeCode;return JSON.stringify({orderBy:v,sublayerHash:g,subtypeCode:_,filterHash:(0,Z.pC)(this.filter)&&this.filter.toJSON(),effectHash:(0,Z.pC)(this.featureEffect)&&this.featureEffect.toJSON(),streamFilter:d,gdbVersion:o,definitionExpression:a,historicMoment:l,availableFields:r,renderer:u,labelingInfo:s,timeExtent:c,floors:i,clipsHash:h,featureReduction:y,customParameters:p,apiKey:f})}},{key:"highlight",value:function(e){var t,r,n=this;e instanceof d.Z?r=[e.getObjectId()]:"number"==typeof e||"string"==typeof e?r=[e]:_.Z.isCollection(e)&&e.length>0?r=e.map((function(e){return null===e||void 0===e?void 0:e.getObjectId()})).toArray():Array.isArray(e)&&e.length>0&&(r="number"==typeof e[0]||"string"==typeof e[0]?e:e.map((function(e){return null===e||void 0===e?void 0:e.getObjectId()})));var i=null===(t=r)||void 0===t?void 0:t.filter(Z.pC);return i&&i.length?(this._addHighlight(i),{remove:function(){return n._removeHighlight(i)}}):{remove:function(){}}}},{key:"hasHighlight",value:function(){return!!this._highlightIds.size}},{key:"hitTest",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,r){var n,i,u,o,l=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.tileRenderer){e.next=2;break}return e.abrupt("return",null);case 2:return e.next=4,this.tileRenderer.hitTest(r);case 4:if(0!==(n=e.sent).length){e.next=7;break}return e.abrupt("return",null);case 7:return e.next=9,this._proxy.getFeatures(n);case 9:return i=e.sent,u=i.features,o=i.aggregates,e.abrupt("return",[].concat((0,a.Z)(o.map((function(e){return l._createGraphicHit(t,g.fromJSON(e))}))),(0,a.Z)(u.map((function(e){return l._createGraphicHit(t,d.Z.fromJSON(e))})))));case 13:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"queryStatistics",value:function(){return this._proxy.queryStatistics()}},{key:"querySummaryStatistics",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,r,n){var a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=(0,i.Z)((0,i.Z)({},r),{},{scale:this.view.scale}),e.abrupt("return",this._proxy.querySummaryStatistics(this._cleanUpQuery(t),a,n));case 2:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"queryAggregateSummaryStatistics",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,r,n){var a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=(0,i.Z)((0,i.Z)({},r),{},{scale:this.view.scale}),e.abrupt("return",this._proxy.queryAggregateSummaryStatistics(this._cleanUpAggregateQuery(t),a,n));case 2:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"queryUniqueValues",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,r,n){var a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=(0,i.Z)((0,i.Z)({},r),{},{scale:this.view.scale}),e.abrupt("return",this._proxy.queryUniqueValues(this._cleanUpQuery(t),a,n));case 2:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"queryAggregateUniqueValues",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,r,n){var a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=(0,i.Z)((0,i.Z)({},r),{},{scale:this.view.scale}),e.abrupt("return",this._proxy.queryAggregateUniqueValues(this._cleanUpAggregateQuery(t),a,n));case 2:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"queryClassBreaks",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,r,n){var a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=(0,i.Z)((0,i.Z)({},r),{},{scale:this.view.scale}),e.abrupt("return",this._proxy.queryClassBreaks(this._cleanUpQuery(t),a,n));case 2:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"queryAggregateClassBreaks",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,r,n){var a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=(0,i.Z)((0,i.Z)({},r),{},{scale:this.view.scale}),e.abrupt("return",this._proxy.queryAggregateClassBreaks(this._cleanUpAggregateQuery(t),a,n));case 2:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"queryHistogram",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,r,n){var a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=(0,i.Z)((0,i.Z)({},r),{},{scale:this.view.scale}),e.abrupt("return",this._proxy.queryHistogram(this._cleanUpQuery(t),a,n));case 2:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"queryAggregateHistogram",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,r,n){var a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=(0,i.Z)((0,i.Z)({},r),{},{scale:this.view.scale}),e.abrupt("return",this._proxy.queryAggregateHistogram(this._cleanUpAggregateQuery(t),a,n));case 2:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"queryFeatures",value:function(e,t){var r=this;return this.queryFeaturesJSON(e,t).then((function(e){var t=T.Z.fromJSON(e);return t.features.forEach((function(e){return r._setLayersForFeature(e)})),t}))}},{key:"queryVisibleFeatures",value:function(e,t){var r=this;return this._proxy.queryVisibleFeatures(this._cleanUpQuery(e),t).then((function(e){var t=T.Z.fromJSON(e);return t.features.forEach((function(e){return r._setLayersForFeature(e)})),t}))}},{key:"queryAggregates",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,r){var n,i,a=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._proxy.queryAggregates(this._cleanUpAggregateQuery(t),r);case 2:return n=e.sent,i=V.fromJSON(n),e.abrupt("return",(i.features.forEach((function(e){return a._setLayersForFeature(e)})),i));case 5:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"queryAggregateIds",value:function(e,t){return this._proxy.queryAggregateIds(this._cleanUpAggregateQuery(e),t)}},{key:"queryAggregateCount",value:function(e,t){return this._proxy.queryAggregateCount(this._cleanUpAggregateQuery(e),t)}},{key:"queryAggregateJSON",value:function(e,t){return this._proxy.queryAggregates(this._cleanUpAggregateQuery(e),t)}},{key:"queryFeaturesJSON",value:function(e,t){return this._proxy.queryFeatures(this._cleanUpQuery(e),t)}},{key:"queryObjectIds",value:function(e,t){return this._proxy.queryObjectIds(this._cleanUpQuery(e),t)}},{key:"queryFeatureCount",value:function(e,t){return this._proxy.queryFeatureCount(this._cleanUpQuery(e),t)}},{key:"queryExtent",value:function(e,t){return this._proxy.queryExtent(this._cleanUpQuery(e),t).then((function(e){return{count:e.count,extent:ke.Z.fromJSON(e.extent)}}))}},{key:"setVisibility",value:function(e,t){t?this._visibilityOverrides.delete(e):this._visibilityOverrides.add(e),this._update()}},{key:"update",value:function(e){if(this._tileStrategy&&this.tileRenderer){var t=this._tileStrategy.update(e),r=t.hasMissingTiles,n=t.added,i=t.removed;(n.length||i.length)&&this._proxy.updateTiles({added:n,removed:i}),r&&this.requestUpdate(),this.notifyChange("updating")}}},{key:"attach",value:function(){var e=this;this.view.timeline.record("".concat(this.layer.title," (FeatureLayer) Attach")),this._tileStrategy=new se({acquireTile:function(t){return e._acquireTile(t)},releaseTile:function(t){return e._releaseTile(t)},tileInfoView:this.view.featuresTilingScheme,buffer:0}),this.addAttachHandles((0,R.YP)((function(){return e.renderingConfigHash}),(function(){return e._update()}),R.nn)),"stream"!==this.layer.type&&this.addAttachHandles(this.layer.on("edits",(function(t){return e._edit(t)})))}},{key:"detach",value:function(){var e,t;this._commandsQueue.clear(),null!==(e=this._proxy)&&void 0!==e&&e.stop(),this.container.removeAllChildren(),null!==(t=this.tileRenderer)&&void 0!==t&&t.uninstall(this.container),this.tileRenderer=null,this._tileStrategy=(0,Z.SC)(this._tileStrategy),this._tileRendererHash=null}},{key:"moveStart",value:function(){this.requestUpdate()}},{key:"viewChange",value:function(){this.requestUpdate()}},{key:"moveEnd",value:function(){this.requestUpdate()}},{key:"isUpdating",value:function(){var e,t="renderer"in this.layer&&null!=this.layer.renderer,r=this._commandsQueue.updating,n=null!=this._updatingRequiredFieldsPromise,i=!this._proxy||!this._proxy.isReady,a=this._pipelineIsUpdating,s=null==this.tileRenderer||(null===(e=this.tileRenderer)||void 0===e?void 0:e.updating),u=t&&(r||n||i||a||s);return(0,k.Z)("esri-2d-log-updating")&&console.log("Updating FLV2D: ".concat(u,"\n  -> hasRenderer ").concat(t,"\n  -> hasPendingCommand ").concat(r,"\n  -> updatingRequiredFields ").concat(n,"\n  -> updatingProxy ").concat(i,"\n  -> updatingPipeline ").concat(a,"\n  -> updatingTileRenderer ").concat(s,"\n")),u}},{key:"_createClientOptions",value:function(){var e=this;return{setUpdating:function(t){e._set("_pipelineIsUpdating",t)},emitEvent:function(t){e.emit(t.name,t.event)}}}},{key:"_detectQueryMode",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var r,n,i,a,u,o,l,c,p,f,d,h,y,v,g;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n="path"in t,i=this.layer,a="editingInfo"in i&&(null===(r=i.editingInfo)||void 0===r?void 0:r.lastEditDate),u="refreshInterval"in i&&!!i.refreshInterval,o=!a&&u,l=(0,I.S1)(i),!n||"feature"!==i.type&&"subtype-group"!==i.type||"point"!==i.geometryType||null===l||void 0===l||!l.query.supportsPagination||null!==l&&void 0!==l&&l.operations.supportsEditing||o||!(0,k.Z)("featurelayer-snapshot-enabled")){e.next=16;break}return e.prev=2,e.next=5,i.queryFeatureCount();case 5:if(!((c=e.sent)<=(0,k.Z)("featurelayer-snapshot-point-min-threshold"))){e.next=8;break}return e.abrupt("return",{mode:"snapshot",featureCount:c});case 8:if(p=(0,k.Z)("featurelayer-snapshot-point-max-threshold"),f=(0,k.Z)("featurelayer-snapshot-point-coverage"),d=this.view.extent,h=(0,Z.Wg)(i.fullExtent),y=null===h||void 0===h?void 0:h.clone().intersection(d),v=(0,Z.pC)(y)?y.width*y.height:0,g=(null===h||void 0===h?void 0:h.width)*(null===h||void 0===h?void 0:h.height),!(c<=p&&(0===g?0:v/g)>=f)){e.next=11;break}return e.abrupt("return",{mode:"snapshot",featureCount:c});case 11:e.next=16;break;case 13:e.prev=13,e.t0=e.catch(2),x.Z.getLogger(this.declaredClass).warn("mapview-feature-layer","Encountered an error when querying for featureCount",{error:e.t0});case 16:return e.abrupt("return",{mode:"on-demand"});case 17:case"end":return e.stop()}}),e,this,[[2,13]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_createServiceOptions",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,r,n,i,a,u,o,l,c,p,f,d,h,y,v,g,_,m,k,x,w,R;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("stream"!==(a=this.layer).type){e.next=3;break}return e.abrupt("return",null);case 3:if(u=(0,I.S1)(a),o=a.capabilities,l=a.objectIdField,c=a.fields.map((function(e){return e.toJSON()})),p=(0,Z.pC)(a.fullExtent)?a.fullExtent.toJSON():null,f=(0,ne.oq)(a.geometryType),d="timeInfo"in a&&a.timeInfo&&a.timeInfo.toJSON()||null,h=a.spatialReference?a.spatialReference.toJSON():null,y="feature"===a.type?a.globalIdField:null,"ogc-feature"!==a.type){e.next=8;break}v=a.source.getSource(),e.next=15;break;case 8:if(!be(a.source)){e.next=14;break}return e.next=11,a.source.openPorts();case 11:v=e.sent,e.next=15;break;case 14:a.parsedUrl&&(v=(0,b.d9)(a.parsedUrl),"dynamicDataSource"in a&&a.dynamicDataSource&&(v.query={layer:JSON.stringify({source:a.dynamicDataSource})}));case 15:return g="datesInUnknownTimezone"in this.layer&&this.layer.datesInUnknownTimezone,_=null!==(t="subtypeField"in this.layer?this.layer.subtypeField:null)&&void 0!==t?t:null,e.next=19,this._detectQueryMode(v);case 19:return m=e.sent,k=m.mode,x=m.featureCount,w=this.layer.objectIdField,"feature"===this.layer.type&&(0,Z.pC)(this.layer.orderBy)&&this.layer.orderBy.length&&(R=!this.layer.orderBy[0].valueExpression&&this.layer.orderBy[0].field)&&(w=R),e.abrupt("return",{type:k,timeReferenceUnknownClient:g,subtypeField:_,featureCount:x,globalIdField:y,maxRecordCount:o.query.maxRecordCount,tileMaxRecordCount:o.query.tileMaxRecordCount,capabilities:o,effectiveCapabilities:u,fields:c,fullExtent:p,geometryType:f,objectIdField:l,source:v,timeInfo:d,spatialReference:h,orderByFields:w,datesInUnknownTimezone:g,dateFieldsTimeReference:("dateFieldsTimeReference"in this.layer?null===(r=this.layer.dateFieldsTimeReference)||void 0===r?void 0:r.toJSON():null)||null,preferredTimeReference:("preferredTimeReference"in this.layer?null===(n=this.layer.preferredTimeReference)||void 0===n?void 0:n.toJSON():null)||null,editFieldsInfo:"editFieldsInfo"in this.layer?null===(i=this.layer.editFieldsInfo)||void 0===i?void 0:i.toJSON():null});case 25:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_createMemoryServiceOptions",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.openPorts();case 2:return r=e.sent,e.abrupt("return",(0,i.Z)((0,i.Z)({},this._createServiceOptions()),{},{type:"memory",source:r}));case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_cleanUpQuery",value:function(e){var t=P.Z.from(e)||this.createQuery();return t.outSpatialReference||(t.outSpatialReference=this.view.spatialReference),t}},{key:"_cleanUpAggregateQuery",value:function(e){var t=P.Z.from(e)||this.createAggregateQuery();return t.outSpatialReference||(t.outSpatialReference=this.view.spatialReference),t}},{key:"_update",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._commandsQueue.push({type:"update"}));case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_edit",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.suspended){e.next=2;break}return e.abrupt("return",void this._clearTiles());case 2:return e.abrupt("return",this._validateEdit(t)?this._commandsQueue.push({type:"edit",edits:t}):void 0);case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"doRefresh",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.attached||!this._tileStrategy.tileKeys().length){e.next=2;break}return e.abrupt("return",this.suspended&&t?void this._clearTiles():this._commandsQueue.push({type:"refresh",dataChanged:t}));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_clearTiles",value:function(){this._tileStrategy.tileKeys().length&&(this._proxy.updateTiles({added:[],removed:this._tileStrategy.tileKeys()}),this._tileStrategy.clear(),this.requestUpdate(),this._commandsQueue.clear(),this._update())}},{key:"_validateEdit",value:function(e){var t="globalIdField"in this.layer&&this.layer.globalIdField,r=e.deletedFeatures.some((function(e){return-1===e.objectId||!e.objectId})),n=t&&this.availableFields.includes(t);return r&&!n?(x.Z.getLogger(this.declaredClass).error(new m.Z("mapview-apply-edits","Editing the specified service requires the layer's globalIdField, ".concat(t," to be included the layer's outFields for updates to be reflected on the map"))),null):e}},{key:"_doUpdate",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,r,n,i,a,u,o,l,c,p,f,d,h,y,v;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!this.destroyed&&this._hasRequiredSupport(this.layer)&&this._tileStrategy){e.next=3;break}return e.abrupt("return");case 3:return t=this.featureEffectView,r=this.filter,e.next=6,this._updateRequiredFields();case 6:if(!this.destroyed){e.next=8;break}return e.abrupt("return");case 8:if(n=this._getEffectiveRenderer(),i=n.renderer,this._set("_effectiveRenderer",i),a=this._createSchemaConfig(),u=this._createConfiguration(a,r,t.filter),o=this._lastDefinitionExpression!==u.schema.source.definitionExpression,this._lastDefinitionExpression=u.schema.source.definitionExpression,l=u.schema.tileRenderer,c=this._createTileRendererHash(l),"snapshot"===this._serviceOptions.type&&(u.schema.source.initialFeatureCount=this._serviceOptions.featureCount),c===this._tileRendererHash){e.next=43;break}return e.next=16,this._initTileRenderer(l,i);case 16:if("stream"!==(p=this.layer).type){e.next=23;break}return e.next=20,this._initServiceOptions();case 20:e.t0=e.sent,e.next=24;break;case 23:e.t0=this._serviceOptions;case 24:if(f=e.t0,this.tileRenderer.onConfigUpdate(i),e.t1="stream"!==p.type&&be(p.source),!e.t1){e.next=31;break}return e.next=30,p.source.openPorts();case 30:f.source=e.sent;case 31:return d={added:this._tileStrategy.tileKeys(),removed:[]},e.next=34,this._proxy.startup(this.view.featuresTilingScheme,u,f,d);case 34:if(e.t2=this.hasHighlight(),!e.t2){e.next=38;break}return e.next=38,this._proxy.setHighlight(Array.from(this._highlightIds.keys()));case 38:return e.next=40,this._onceTilesUpdated();case 40:this.tileRenderer.onConfigUpdate(i),e.next=61;break;case 43:if(e.t3="snapshot"===this._serviceOptions.type&&o,!e.t3){e.next=48;break}return e.next=47,this.layer.queryFeatureCount();case 47:u.schema.source.changedFeatureCount=e.sent;case 48:return e.next=50,this._proxy.update(u);case 50:return((v=e.sent).mesh||(null===(h=v.targets)||void 0===h?void 0:h.aggregate))&&this._lockGPUUploads(),e.prev=52,e.next=55,this._proxy.applyUpdate(v);case 55:e.next=60;break;case 57:e.prev=57,e.t4=e.catch(52),(0,w.D_)(e.t4)||x.Z.getLogger(this.declaredClass).error(e.t4);case 60:(v.mesh||null!==(y=v.targets)&&void 0!==y&&y.aggregate)&&this._unlockGPUUploads(),this.tileRenderer.onConfigUpdate(i),this._updateClusterSizeVariable(),this._forceAttributeTextureUpload();case 61:this._tileRendererHash=c,this.tileRenderer.invalidateLabels(),this.requestUpdate(),e.next=66;break;case 64:e.prev=64,e.t5=e.catch(0);case 66:case"end":return e.stop()}}),e,this,[[0,64],[52,57]])})));return function(){return e.apply(this,arguments)}}()},{key:"_doEdit",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._proxy.onEdits(t);case 3:e.next=8;break;case 5:e.prev=5,e.t0=e.catch(0),(0,w.D_)(e.t0);case 8:case"end":return e.stop()}}),e,this,[[0,5]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_doRefresh",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._lockGPUUploads(),e.prev=1,e.t0=t&&"snapshot"===this.queryMode&&"queryFeatureCount"in this.layer,!e.t0){e.next=7;break}return e.next=6,this.layer.queryFeatureCount();case 6:r=e.sent;case 7:return e.next=9,this._proxy.refresh({dataChanged:t,featureCount:r});case 9:e.next=14;break;case 11:e.prev=11,e.t1=e.catch(1),(0,w.D_)(e.t1);case 14:this._unlockGPUUploads(),this._effectiveFeatureReduction&&this._updateClusterSizeVariable();case 15:case"end":return e.stop()}}),e,this,[[1,11]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_updateClusterSizeVariable",value:function(){this._needsClusterSizeUpdate&&(this.tileRenderer.onConfigUpdate(this._effectiveRenderer),this._needsClusterSizeUpdate=!1)}},{key:"_createUpdateClusterSizeTask",value:function(e,t){var r=this;return(0,R.YP)((function(){return r._aggregateValueRanges}),(function(n){r._updateClusterEffectiveRendererSizeVariable(e,t,n),r._needsClusterSizeUpdate=!0,r._uploadsLocked||r._updateClusterSizeVariable()}))}},{key:"_updateClusterEffectiveRendererSizeVariable",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,r,n){var i,a,u;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t.dynamicClusterSize&&"visualVariables"in t&&t.visualVariables&&(i=(0,j.os)(t.visualVariables),(0,Z.pC)(i)&&"cluster_count"===i.field&&(a=t.visualVariables.indexOf(i),t.visualVariables[a]=(0,j.aV)(r,n),(u=t.clone()).dynamicClusterSize=!0,this._set("_effectiveRenderer",u)));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_getEffectiveRenderer",value:function(){var e,t=this.layer,r="renderer"in t?t.renderer:null,n=this._effectiveFeatureReduction;if(this._updateClusterSizeTask=(0,Z.hw)(this._updateClusterSizeTask),n&&"renderer"in n&&n.renderer&&(null===(e=n.renderer.authoringInfo)||void 0===e||!e.isAutoGenerated)){var i=n.fields;if("cluster"===n.type){var a=(0,j.st)(n.renderer,n,this._aggregateValueRanges),s=a.renderer;return a.didInject&&(this._updateClusterSizeTask=this._createUpdateClusterSizeTask(s,n)),{renderer:s,aggregateFields:i,featureReduction:n}}return{renderer:n.renderer,aggregateFields:i,featureReduction:n}}if(n&&"cluster"===n.type&&r&&(0,j.yR)(r)){var u=n,o=[],l=(0,j.S1)(o,r,u,this._aggregateValueRanges,!0);return this._updateClusterSizeTask=this._createUpdateClusterSizeTask(l,u),{renderer:l,aggregateFields:o,featureReduction:n}}return{renderer:r,aggregateFields:[],featureReduction:null}}},{key:"_acquireTile",value:function(e){var t=this,r=this.tileRenderer.acquireTile(e);return r.once("attach",(function(){t.requestUpdate()})),r}},{key:"_releaseTile",value:function(e){this.tileRenderer.releaseTile(e)}},{key:"_initTileRenderer",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,r){var n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,z(t,{layerView:this,tileInfoView:this.view.featuresTilingScheme,layer:this.layer});case 2:return n=e.sent,e.abrupt("return",(this.tileRenderer&&(this._tileStrategy.clear(),this.tileRenderer.uninstall(this.container),this.tileRenderer=(0,Z.SC)(this.tileRenderer)),this.destroyed?null:(this._proxy.tileRenderer=n,this._set("tileRenderer",n),this.tileRenderer.install(this.container),this.tileRenderer.onConfigUpdate(r),this.requestUpdate(),this.tileRenderer)));case 4:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_createTileRendererHash",value:function(e){return"".concat(e.type)}},{key:"hasFilter",get:function(){var e=!!("floorInfo"in this.layer&&this.layer.floorInfo&&this.view.floors&&this.view.floors.length);return!!this.filter||e||!!this._visibilityOverrides.size||!!this.timeExtent}},{key:"_injectOverrides",value:function(e){var t=(0,Z.pC)(e)?e.timeExtent:null,r=(0,Z.pC)(this.timeExtent)&&(0,Z.pC)(t)?this.timeExtent.intersection(t):this.timeExtent||t,n=null,i="floorInfo"in this.layer&&this.layer.floorInfo;if(i){var a=(0,Z.pC)(e)?e.where:null;n=this._addFloorFilterClause(a)}if(!this._visibilityOverrides.size&&!r&&!i)return(0,Z.pC)(e)?e.toJSON():null;(e=(0,Z.pC)(e)&&e.clone()||new E.Z).timeExtent=r,n&&(e.where=n);var s=e.toJSON();return s.hiddenIds=Array.from(this._visibilityOverrides),s}},{key:"_addFloorFilterClause",value:function(e){var t=this.layer,r=e||"";if("floorInfo"in t&&t.floorInfo){var n,i=this.view.floors;if(!i||!i.length)return r;(null===(n=t.floorInfo.viewAllLevelIds)||void 0===n?void 0:n.length)&&(i=t.floorInfo.viewAllLevelIds);var a=i.filter((function(e){return""!==e})).map((function(e){return"'"+e+"'"}));a.push("''");var s=t.floorInfo.floorField,u="("+s+" IN ({ids}) OR "+s+" IS NULL)";if(u=u.replace("{ids}",a.join(", ")),(0,Z.pC)(r)&&r.includes(s)){var o=new RegExp("AND \\("+s+".*NULL\\)","g");r=r.replace(o,""),o=new RegExp("\\("+s+".*NULL\\)","g"),r=(r=r.replace(o,"")).replace(/\s+/g," ").trim()}r=""!==r?"("+r+") AND "+u:u}return""!==r?r:null}},{key:"_createConfiguration",value:function(e,t,r){var n,i="feature"===this.layer.type&&this.layer.historicMoment?this.layer.historicMoment.getTime():void 0,a="feature"===this.layer.type&&null!==(n=this.layer.gdbVersion)&&void 0!==n?n:void 0,s=new Array(N.m4),u=this._injectOverrides(t);s[0]=u,s[1]=(0,Z.pC)(r)?r.toJSON():null;var o=(0,L.Ew)(e);if((0,Z.Wi)(o))return null;var l=(0,me.hc)("2d");return{availableFields:this.availableFields,gdbVersion:a,historicMoment:i,devicePixelRatio:window.devicePixelRatio||1,filters:s,schema:o,supportsTextureFloat:l.supportsTextureFloat,maxTextureSize:l.maxTextureSize}}},{key:"_hasRequiredSupport",value:function(e){return!("renderer"in e)||(0,H.TT)(e.renderer)}},{key:"_onceTilesUpdated",value:function(){var e=this;return this.requestUpdate(),(0,R.N1)((function(){return!e._pipelineIsUpdating}))}},{key:"_lockGPUUploads",value:function(){this.tileRenderer&&(this._uploadsLocked=!0,this.tileRenderer.lockGPUUploads())}},{key:"_unlockGPUUploads",value:function(){this.tileRenderer&&(this._uploadsLocked=!1,this.tileRenderer.unlockGPUUploads())}},{key:"_forceAttributeTextureUpload",value:function(){this.tileRenderer&&this.tileRenderer.forceAttributeTextureUpload()}},{key:"_createSchemaConfig",value:function(){var e,t=this.layer;return{renderer:"renderer"in t?t.renderer:null,spatialReference:t.spatialReference,timeExtent:"timeExtent"in t?t.timeExtent:null,definitionExpression:t.definitionExpression,featureReduction:this._effectiveFeatureReduction,fields:t.fields,geometryType:t.geometryType,historicMoment:"historicMoment"in t?t.historicMoment:null,labelsVisible:"labelsVisible"in t&&t.labelsVisible,labelingInfo:"labelingInfo"in t?t.labelingInfo:null,availableFields:this.availableFields,featureEffect:this.featureEffect,filter:this.filter,gdbVersion:"gdbVersion"in t?t.gdbVersion:null,pixelBuffer:0,orderBy:"orderBy"in t&&t.orderBy?t.orderBy:null,customParameters:(0,i.Z)((0,i.Z)({},"customParameters"in t?t.customParameters:void 0),{},{token:"apiKey"in t&&null!==(e=t.apiKey)&&void 0!==e?e:void 0}),subtypeCode:"subtypeCode"in t?t.subtypeCode:void 0,subtypeField:"subtypeField"in t?t.subtypeField:void 0}}},{key:"_addHighlight",value:function(e){var t,r=this,i=(0,n.Z)(e);try{for(i.s();!(t=i.n()).done;){var a=t.value;if(this._highlightIds.has(a)){var s=this._highlightIds.get(a);this._highlightIds.set(a,s+1)}else this._highlightIds.set(a,1)}}catch(u){i.e(u)}finally{i.f()}this._updateHighlight().catch((function(e){(0,w.D_)(e)||x.Z.getLogger(r.declaredClass).error(e)}))}},{key:"_removeHighlight",value:function(e){var t,r=this,i=(0,n.Z)(e);try{for(i.s();!(t=i.n()).done;){var a=t.value;if(this._highlightIds.has(a)){var s=this._highlightIds.get(a)-1;0===s?this._highlightIds.delete(a):this._highlightIds.set(a,s)}}}catch(u){i.e(u)}finally{i.f()}this._updateHighlight().catch((function(e){(0,w.D_)(e)||x.Z.getLogger(r.declaredClass).error(e)}))}},{key:"_setLayersForFeature",value:function(e){var t=this.layer;e.layer=t,e.sourceLayer=t}},{key:"_createGraphicHit",value:function(e,t){return this._setLayersForFeature(t),(0,Z.pC)(t.geometry)&&(t.geometry.spatialReference=this.view.spatialReference),{type:"graphic",graphic:t,layer:this.layer,mapPoint:e}}}]),r}(function(e){var t=function(e){(0,c.Z)(r,e);var t=(0,p.Z)(r);function r(){var e;(0,o.Z)(this,r);for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return(e=t.call.apply(t,[this].concat(i)))._updatingRequiredFieldsPromise=null,e.filter=null,e.timeExtent=null,e.layer=null,e.requiredFields=[],e.view=null,e}return(0,l.Z)(r,[{key:"initialize",value:function(){var e=this;this.handles.add([(0,R.YP)((function(){var t,r=e.layer;return[null===r||void 0===r||null===(t=r.elevationInfo)||void 0===t?void 0:t.featureExpressionInfo,r&&"displayField"in r?r.displayField:null,r&&"timeInfo"in r&&r.timeInfo,r&&"renderer"in r&&r.renderer,r&&"labelingInfo"in r&&r.labelingInfo,r&&"floorInfo"in r&&r.floorInfo,e.filter,e.featureEffect,e.timeExtent]}),(function(){return e._handleRequiredFieldsChange()}),R.tX),(0,R.on)((function(){var t;return null===(t=e.view)||void 0===t?void 0:t.floors}),"change",(function(){return e._handleRequiredFieldsChange()})),(0,R.on)((function(){var t=e.layer;return t&&"sublayers"in t?t.sublayers:null}),"change",(function(){return e._handleRequiredFieldsChange()}))])}},{key:"availableFields",get:function(){var e=this.layer,t=this.layer.fieldsIndex,r=this.requiredFields;return"outFields"in e&&e.outFields?(0,pe.Q0)(t,[].concat((0,a.Z)((0,pe.Lk)(t,e.outFields)),(0,a.Z)(r))):(0,pe.Q0)(t,r)}},{key:"featureEffect",get:function(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null},set:function(e){this._override("featureEffect",e)}},{key:"maximumNumberOfFeatures",get:function(){return 0},set:function(e){ve.error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}},{key:"maximumNumberOfFeaturesExceeded",get:function(){return!1}},{key:"highlight",value:function(e){throw new Error("missing implementation")}},{key:"createQuery",value:function(){var e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},t=(0,Z.pC)(this.filter)?this.filter.createQuery(e):new P.Z(e);if("feature"===this.layer.type){var r=(0,fe.c)(this);(0,Z.pC)(r)&&(t.where=t.where?"(".concat(t.where,") AND (").concat(r,")"):r)}return(0,Z.pC)(this.timeExtent)&&(t.timeExtent=(0,Z.pC)(t.timeExtent)?t.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),t}},{key:"createAggregateQuery",value:function(){var e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return new P.Z(e)}},{key:"queryFeatures",value:function(e,t){throw new Error("missing implementation")}},{key:"queryObjectIds",value:function(e,t){throw new Error("missing implementation")}},{key:"queryFeatureCount",value:function(e,t){throw new Error("missing implementation")}},{key:"queryExtent",value:function(e,t){throw new Error("missing implementation")}},{key:"fetchPopupFeatures",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,r){var n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n=this.validateFetchPopupFeatures(r))){e.next=3;break}throw n;case 3:return e.abrupt("return",this.fetchClientPopupFeatures(r));case 4:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_loadArcadeModules",value:function(e){return e.get("expressionInfos.length")||Array.isArray(e.content)&&e.content.some((function(e){return"expression"===e.type}))?(0,de.LC)():Promise.resolve()}},{key:"_handleRequiredFieldsChange",value:function(){var e=this,t=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",t),t.then((function(){e._updatingRequiredFieldsPromise===t&&e._set("_updatingRequiredFieldsPromise",null)}))}},{key:"_updateRequiredFields",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,r,i,a,u,o,l,c,p,f,d,h,y,v,g;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.layer&&this.view){e.next=2;break}return e.abrupt("return");case 2:return t="3d"===this.view.type,r=this.layer,i=this.layer,a=i.fieldsIndex,u=i.objectIdField,o="renderer"in r&&r.renderer,l="orderBy"in r&&r.orderBy,c="featureReduction"in r?r.featureReduction:null,p=new Set,e.next=13,(0,w.as)([o?o.collectRequiredFields(p,a):null,(0,pe.Mu)(p,r),t?(0,pe.vl)(p,r):null,(0,Z.pC)(this.filter)?(0,pe.Ll)(p,r,this.filter):null,(0,Z.pC)(this.featureEffect)?(0,pe.Ll)(p,r,this.featureEffect.filter):null,c?(0,pe.ZV)(p,r,c):null,l?(0,pe.Qj)(p,r,l):null]);case 13:if(f=e.sent,"timeInfo"in r&&r.timeInfo&&this.timeExtent&&(0,pe.gd)(p,r.fieldsIndex,[r.timeInfo.startField,r.timeInfo.endField]),"feature"===r.type&&(r.floorInfo&&(0,pe.gd)(p,r.fieldsIndex,[r.floorInfo.floorField]),t&&(0,Z.pC)(r.infoFor3D)&&(null==r.globalIdField&&ve.error("globalIdField missing on 3DObjectFeatureLayer"),(0,pe.gd)(p,r.fieldsIndex,[r.globalIdField]))),"subtype-group"!==r.type){e.next=19;break}return(0,pe.AB)(p,a,r.subtypeField),d=r.sublayers.map((function(e){var t;return Promise.all([null===(t=e.renderer)||void 0===t?void 0:t.collectRequiredFields(p,a),(0,pe.Mu)(p,e)])})),e.next=19,(0,w.as)(d);case 19:h=(0,n.Z)(f);try{for(h.s();!(y=h.n()).done;)(v=y.value).error&&ve.error(v.error)}catch(s){h.e(s)}finally{h.f()}(0,pe.AB)(p,a,u),t&&"displayField"in r&&r.displayField&&(0,pe.AB)(p,a,r.displayField),g=Array.from(p).sort(),this._set("requiredFields",g);case 24:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"validateFetchPopupFeatures",value:function(e){var t;if((0,Z.Wi)(e))return null;var r,i=(0,n.Z)(null!==(t=e.clientGraphics)&&void 0!==t?t:[]);try{for(i.s();!(r=i.n()).done;){var a=r.value,s=a.layer;if("popupEnabled"in s&&!s.popupEnabled)return new m.Z("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:s});if(a.isAggregate){var u="featureReduction"in s?s.featureReduction:null;if(!(u&&"popupTemplate"in u&&u.popupEnabled&&u.popupTemplate))return new m.Z("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:s})}else if("popupTemplate"in s&&!(0,he.V)(s,e))return new m.Z("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:s})}}catch(o){i.e(o)}finally{i.f()}}},{key:"fetchClientPopupFeatures",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var r,i,a,u,o,l,c,p,f,d,h,y,v,g,_,m,k;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((r=(0,Z.pC)(t)?t.clientGraphics:null)&&0!==r.length){e.next=3;break}return e.abrupt("return",[]);case 3:return i=new Array(r.length),a=new Map,e.next=7,this.createPopupQuery(t);case 7:u=e.sent,o=0;case 9:if(!(o<r.length)){e.next=27;break}if(!(l=r[o]).isAggregate){e.next=14;break}return i[o]=l,e.abrupt("continue",24);case 14:if("popupEnabled"in(c=l.layer)){e.next=17;break}return e.abrupt("continue",24);case 17:if(p=(0,pe.Lk)(this.layer.fieldsIndex,u.outFields),f=(0,he.V)(c,t),!(0,Z.Wi)(f)){e.next=20;break}return e.abrupt("continue",24);case 20:return e.next=22,this._loadArcadeModules(f);case 22:(d=e.sent)&&d.arcadeUtils.hasGeometryOperations(f)||!(0,pe.R9)(p,l)?a.set(l.getObjectId(),{graphic:l,index:o}):i[o]=l;case 24:o++,e.next=9;break;case 27:if("stream"!==this.layer.type&&0!==a.size){e.next=29;break}return e.abrupt("return",i.filter(Boolean));case 29:return u.objectIds=Array.from(a.keys()),e.prev=30,e.next=33,this.layer.queryFeatures(u);case 33:h=e.sent,y=(0,n.Z)(h.features);try{for(y.s();!(v=y.n()).done;)g=v.value,_=a.get(g.getObjectId()),m=_.graphic.geometry,k=_.index,g.geometry||(g.geometry=m),i[k]=g}catch(s){y.e(s)}finally{y.f()}e.next=40;break;case 38:e.prev=38,e.t0=e.catch(30);case 40:return e.abrupt("return",i.filter(Boolean));case 41:case"end":return e.stop()}}),e,this,[[30,38]])})));return function(t){return e.apply(this,arguments)}}()},{key:"createPopupQuery",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var r,i,a,u,o,l,c,p,f,d,h,y,v,g,_;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=this.layer.createQuery(),i=new Set,a=!1,u=(0,Z.pC)(t)&&t.clientGraphics?t.clientGraphics.map((function(e){return e.layer})):[this.layer],o=(0,n.Z)(u),e.prev=4,o.s();case 6:if((l=o.n()).done){e.next=25;break}if("popupEnabled"in(c=l.value)){e.next=10;break}return e.abrupt("continue",23);case 10:if(p=(0,he.V)(c,t),!(0,Z.Wi)(p)){e.next=13;break}return e.abrupt("continue",23);case 13:return e.next=15,this._loadArcadeModules(p);case 15:return f=e.sent,d=f&&f.arcadeUtils.hasGeometryOperations(p),a=!("point"!==this.layer.geometryType&&!d),e.next=20,(0,he.e)(this.layer,p);case 20:h=e.sent,y=(0,n.Z)(h);try{for(y.s();!(v=y.n()).done;)g=v.value,i.add(g)}catch(s){y.e(s)}finally{y.f()}case 23:e.next=6;break;case 25:e.next=30;break;case 27:e.prev=27,e.t0=e.catch(4),o.e(e.t0);case 30:return e.prev=30,o.f(),e.finish(30);case 33:return r.returnGeometry=a,r.returnZ=a,r.returnM=a,r.outFields=Array.from(i),r.outSpatialReference=this.view.spatialReference,"feature"===this.layer.type&&(_=(0,fe.c)(this),(0,Z.pC)(_)&&(r.where=r.where?"(".concat(r.where,") AND (").concat(_,")"):_)),e.abrupt("return",r);case 35:case"end":return e.stop()}}),e,this,[[4,27,30,33]])})));return function(t){return e.apply(this,arguments)}}()},{key:"canResume",value:function(){return!!(0,ue.Z)((0,oe.Z)(r.prototype),"canResume",this).call(this)&&(!(0,Z.pC)(this.timeExtent)||!this.timeExtent.isEmpty)}}]),r}(e);return(0,f._)([(0,h.Cb)()],t.prototype,"_updatingRequiredFieldsPromise",void 0),(0,f._)([(0,h.Cb)({readOnly:!0})],t.prototype,"availableFields",null),(0,f._)([(0,h.Cb)({type:ce.Z})],t.prototype,"featureEffect",null),(0,f._)([(0,h.Cb)({type:E.Z})],t.prototype,"filter",void 0),(0,f._)([(0,h.Cb)(le.qG)],t.prototype,"timeExtent",void 0),(0,f._)([(0,h.Cb)()],t.prototype,"layer",void 0),(0,f._)([(0,h.Cb)({type:Number})],t.prototype,"maximumNumberOfFeatures",null),(0,f._)([(0,h.Cb)({readOnly:!0,type:Boolean})],t.prototype,"maximumNumberOfFeaturesExceeded",null),(0,f._)([(0,h.Cb)({readOnly:!0})],t.prototype,"requiredFields",void 0),(0,f._)([(0,h.Cb)()],t.prototype,"suspended",void 0),(0,f._)([(0,h.Cb)()],t.prototype,"view",void 0),t=(0,f._)([(0,y.j)(ye)],t),t}((0,_e.Z)((0,J.y)(ge.Z))));(0,f._)([(0,h.Cb)()],xe.prototype,"_serviceOptions",void 0),(0,f._)([(0,h.Cb)()],xe.prototype,"_proxy",void 0),(0,f._)([(0,h.Cb)()],xe.prototype,"_pipelineIsUpdating",void 0),(0,f._)([(0,h.Cb)()],xe.prototype,"_effectiveRenderer",void 0),(0,f._)([(0,h.Cb)()],xe.prototype,"_effectiveFeatureReduction",null),(0,f._)([(0,h.Cb)()],xe.prototype,"_aggregateValueRanges",void 0),(0,f._)([(0,h.Cb)()],xe.prototype,"_commandsQueue",void 0),(0,f._)([(0,h.Cb)()],xe.prototype,"featureEffectView",void 0),(0,f._)([(0,h.Cb)()],xe.prototype,"labelsVisible",null),(0,f._)([(0,h.Cb)({readOnly:!0})],xe.prototype,"queryMode",null),(0,f._)([(0,h.Cb)()],xe.prototype,"renderingConfigHash",null),(0,f._)([(0,h.Cb)()],xe.prototype,"tileRenderer",void 0),(0,f._)([(0,h.Cb)()],xe.prototype,"updating",void 0);var Ze=xe=(0,f._)([(0,y.j)("esri.views.2d.layers.FeatureLayerView2D")],xe)},13107:function(e,t,r){r.d(t,{Z:function(){return d}});var n=r(15671),i=r(43144),a=r(60136),s=r(29388),u=r(27366),o=r(32718),l=r(66978),c=r(94172),p=r(49861),f=(r(25243),r(63780),r(69912)),d=function(e){var t=function(e){(0,a.Z)(r,e);var t=(0,s.Z)(r);function r(){return(0,n.Z)(this,r),t.apply(this,arguments)}return(0,i.Z)(r,[{key:"initialize",value:function(){var e=this;this.handles.add((0,c.on)((function(){return e.layer}),"refresh",(function(t){e.doRefresh(t.dataChanged).catch((function(t){(0,l.D_)(t)||o.Z.getLogger(e.declaredClass).error(t)}))})),"RefreshableLayerView")}}]),r}(e);return(0,u._)([(0,p.Cb)()],t.prototype,"layer",void 0),t=(0,u._)([(0,f.j)("esri.layers.mixins.RefreshableLayerView")],t)}},24405:function(e,t,r){r.d(t,{V:function(){return c},e:function(){return o}});var n=r(74165),i=r(93433),a=r(15861),s=r(92026),u=r(80031);function o(e){return l.apply(this,arguments)}function l(){return l=(0,a.Z)((0,n.Z)().mark((function e(t){var r,a,o,l,c,p,f,d,h,y,v,g=arguments;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=g.length>1&&void 0!==g[1]?g[1]:t.popupTemplate,!(0,s.Wi)(o)){e.next=3;break}return e.abrupt("return",[]);case 3:return e.next=5,o.getRequiredFields(t.fieldsIndex);case 5:if(l=e.sent,c=o.lastEditInfoEnabled,p=t.objectIdField,f=t.typeIdField,d=t.globalIdField,h=t.relationships,!l.includes("*")){e.next=13;break}return e.abrupt("return",["*"]);case 13:if(!c){e.next=19;break}return e.next=16,(0,u.CH)(t);case 16:e.t0=e.sent,e.next=20;break;case 19:e.t0=[];case 20:return y=e.t0,v=(0,u.Q0)(t.fieldsIndex,[].concat((0,i.Z)(l),(0,i.Z)(y))),e.abrupt("return",(f&&v.push(f),v&&p&&null!==(r=t.fieldsIndex)&&void 0!==r&&r.has(p)&&!v.includes(p)&&v.push(p),v&&d&&null!==(a=t.fieldsIndex)&&void 0!==a&&a.has(d)&&!v.includes(d)&&v.push(d),h&&h.forEach((function(e){var r,n=e.keyField;v&&n&&(null===(r=t.fieldsIndex)||void 0===r?void 0:r.has(n))&&!v.includes(n)&&v.push(n)})),v));case 23:case"end":return e.stop()}}),e)}))),l.apply(this,arguments)}function c(e,t){return e.popupTemplate?e.popupTemplate:(0,s.pC)(t)&&t.defaultPopupTemplateEnabled&&(0,s.pC)(e.defaultPopupTemplate)?e.defaultPopupTemplate:null}}}]);
//# sourceMappingURL=143.dc0ceae8.chunk.js.map